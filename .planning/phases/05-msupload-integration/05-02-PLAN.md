---
phase: 05-msupload-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - modules/ext.FilePermissions.msupload.js
  - modules/ext.FilePermissions.msupload.css
autonomous: true

must_haves:
  truths:
    - "Permission dropdown appears prepended to #msupload-div when MsUpload is present on edit page"
    - "Dropdown is populated with configured permission levels from wgFilePermLevels"
    - "Dropdown defaults to namespace-aware default from wgFilePermMsUploadDefault"
    - "Selected permission level is injected into plupload multipart_params as wpFilePermLevel on each file's BeforeUpload"
    - "Dropdown is disabled during upload (plupload STARTED state) and re-enabled when stopped"
    - "Error state shown when wgFilePermLevels is empty or missing"
    - "Post-upload verification queries PageProps and shows mw.notify error if permission was not saved"
    - "Error notifications require manual dismissal (autoHide false)"
  artifacts:
    - path: "modules/ext.FilePermissions.msupload.js"
      provides: "MsUpload bridge: dropdown injection, plupload BeforeUpload binding, post-upload verification"
      min_lines: 80
    - path: "modules/ext.FilePermissions.msupload.css"
      provides: "Styling for dropdown controls and error state in MsUpload area"
      min_lines: 10
  key_links:
    - from: "modules/ext.FilePermissions.msupload.js"
      to: "MsUpload.uploader"
      via: "plupload BeforeUpload event binding"
      pattern: "MsUpload\\.uploader\\.bind.*BeforeUpload"
    - from: "modules/ext.FilePermissions.msupload.js"
      to: "uploader.settings.multipart_params"
      via: "Direct property assignment (NOT setOption)"
      pattern: "uploader\\.settings\\.multipart_params"
    - from: "modules/ext.FilePermissions.msupload.js"
      to: "mw.hook('wikiEditor.toolbarReady')"
      via: "Memorized MW hook for initialization timing"
      pattern: "mw\\.hook.*wikiEditor\\.toolbarReady"
    - from: "modules/ext.FilePermissions.msupload.js"
      to: "mw.Api"
      via: "Post-upload PageProps verification query"
      pattern: "new mw\\.Api|mw\\.Api\\("
---

<objective>
Create the client-side MsUpload bridge: JavaScript module that injects a permission dropdown into MsUpload's toolbar area, hooks into plupload's BeforeUpload event to transmit the selected permission level, disables the dropdown during upload, and verifies permission storage after each file upload.

Purpose: This is the user-facing integration that makes permission selection available during drag-drop uploads via MsUpload. Without this, MsUpload uploads would get namespace/global defaults silently (after Plan 01's fix) but users would have no control.

Output: modules/ext.FilePermissions.msupload.js and modules/ext.FilePermissions.msupload.css
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-msupload-integration/05-RESEARCH.md
@.planning/phases/05-msupload-integration/05-CONTEXT.md
@.planning/phases/05-msupload-integration/05-01-SUMMARY.md
@modules/ext.FilePermissions.edit.js
@extension.json
@i18n/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ext.FilePermissions.msupload.js bridge module</name>
  <files>modules/ext.FilePermissions.msupload.js</files>
  <action>
Create the JavaScript bridge module following the IIFE pattern established in ext.FilePermissions.edit.js. The module is only loaded when MsUpload is installed (server-side check in MsUploadHooks.php from Plan 01).

**Structure:**

```
( function () {
    'use strict';
    // ... module body
}() );
```

**Initialization flow:**

1. Read config vars at module scope:
   - `var levels = mw.config.get( 'wgFilePermLevels' );`
   - `var defaultLevel = mw.config.get( 'wgFilePermMsUploadDefault' );`

2. Guard: if `levels` is falsy or empty array, register a `wikiEditor.toolbarReady` handler that injects an error message div into `#msupload-div` (prepend a div with class `fileperm-msupload-error` and text from `mw.msg( 'filepermissions-msupload-error-nolevels' )`). Then return early — no dropdown, no event binding.

3. Define `buildDropdown()` function:
   - Create container div: `$( '<div>' ).addClass( 'fileperm-msupload-controls' ).attr( 'id', 'fileperm-msupload-controls' )`
   - Create label: `$( '<label>' ).attr( 'for', 'fileperm-msupload-select' ).text( mw.msg( 'filepermissions-msupload-label' ) )`
   - Create select: `$( '<select>' ).attr( { id: 'fileperm-msupload-select', name: 'fileperm-msupload-select' } )`
   - Populate options from `levels` array. Each option: `$( '<option>' ).val( levels[i] ).text( levels[i] )`. If `levels[i] === defaultLevel`, set `selected` prop.
   - If `defaultLevel` is null and levels has items, select the first option.
   - Append label and select to container. Return container jQuery object.

4. Define `getSelectedLevel()`: return `$( '#fileperm-msupload-select' ).val()`.

5. Define `onBeforeUpload( uploader, file )` handler:
   - CRITICAL: This runs AFTER MsUpload's onBeforeUpload (which calls `uploader.setOption('multipart_params', {...})` replacing the entire object). Our handler reads the CURRENT params and adds our field.
   - `var params = uploader.settings.multipart_params || {};`
   - `params.wpFilePermLevel = getSelectedLevel();`
   - `uploader.settings.multipart_params = params;`
   - Do NOT call `uploader.setOption()` — that would replace MsUpload's params.

6. Define `onFileUploaded( uploader, file, response )` handler for post-upload verification:
   - Parse `response.response` as JSON (plupload provides raw response text in `response.response`).
   - Extract the uploaded filename from the API response: `result.upload.filename` if upload was successful.
   - If upload succeeded (check `result.upload && result.upload.result === 'Success'`):
     - Make a lightweight API query to verify permission was stored:
       ```
       new mw.Api().get( {
           action: 'query',
           titles: 'File:' + result.upload.filename,
           prop: 'pageprops',
           ppprop: 'fileperm_level'
       } )
       ```
     - In the `.then()` callback: check if the returned page has `pageprops.fileperm_level`. If missing, show error notification:
       ```
       mw.notify(
           mw.msg( 'filepermissions-msupload-error-save', file.name ),
           { type: 'error', autoHide: false }
       );
       ```
     - `autoHide: false` per CONTEXT.md decision: "Error notifications require manual dismissal."
   - If response parsing fails or upload was not successful, do nothing (MsUpload handles upload errors).

7. Define `onStateChanged( uploader )` handler for dropdown disable/enable:
   - When `uploader.state === plupload.STARTED`: disable the select (`$( '#fileperm-msupload-select' ).prop( 'disabled', true )`).
   - When `uploader.state === plupload.STOPPED`: re-enable (`$( '#fileperm-msupload-select' ).prop( 'disabled', false )`).
   - Reference `plupload.STARTED` (value 2) and `plupload.STOPPED` (value 1). Use the constants if available, numeric fallbacks if not: `if ( typeof plupload !== 'undefined' ) { ... }` with `plupload.STARTED` and `plupload.STOPPED`.

8. Main initialization via `mw.hook( 'wikiEditor.toolbarReady' ).add( function () { ... } )`:
   - Guard: `if ( typeof MsUpload === 'undefined' || !MsUpload.uploader ) { return; }`
   - Guard: `var $msDiv = $( '#msupload-div' ); if ( !$msDiv.length ) { return; }`
   - Prepend dropdown: `$msDiv.prepend( buildDropdown() );`
   - Bind plupload events:
     - `MsUpload.uploader.bind( 'BeforeUpload', onBeforeUpload );`
     - `MsUpload.uploader.bind( 'FileUploaded', onFileUploaded );`
     - `MsUpload.uploader.bind( 'StateChanged', onStateChanged );`

**Things to avoid and why:**
- Do NOT use `uploader.setOption('multipart_params', ...)` — this REPLACES the entire params object that MsUpload already set (action, filename, token, comment). Directly modify `uploader.settings.multipart_params` instead.
- Do NOT use OOUI widgets (DropdownInputWidget etc.) — MsUpload's UI is plain DOM/jQuery. An OOUI widget would look visually out of place and adds unnecessary weight.
- Do NOT add `ext.MsUpload` as a dependency in the module — it is not guaranteed to exist. Server-side check handles this.
- Do NOT use `setInterval` or `MutationObserver` to wait for DOM — use `mw.hook('wikiEditor.toolbarReady')` which is memorized.
- Do NOT show success feedback for permissions — per CONTEXT.md: "No extra success feedback — permissions applied silently on successful upload."
  </action>
  <verify>
1. Read the created file and verify:
   a. IIFE wrapper pattern matching ext.FilePermissions.edit.js
   b. mw.config.get calls for wgFilePermLevels and wgFilePermMsUploadDefault
   c. Error state handling when levels is empty/null
   d. buildDropdown creates plain HTML select (not OOUI)
   e. onBeforeUpload modifies uploader.settings.multipart_params (not setOption)
   f. onFileUploaded does API query to verify PageProps and shows mw.notify on failure
   g. onStateChanged disables/enables dropdown based on plupload state
   h. mw.hook('wikiEditor.toolbarReady') used for initialization
   i. MsUpload.uploader existence guard before binding
   j. Three plupload event bindings: BeforeUpload, FileUploaded, StateChanged
2. Grep for `setOption` in the file — should NOT appear (anti-pattern).
3. Grep for `autoHide.*false` — should appear in error notification.
  </verify>
  <done>
ext.FilePermissions.msupload.js created with: dropdown injection into #msupload-div, plupload BeforeUpload param injection via settings.multipart_params, FileUploaded verification via API query with error notification, StateChanged dropdown disable/enable, and proper error state when levels unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ext.FilePermissions.msupload.css styling</name>
  <files>modules/ext.FilePermissions.msupload.css</files>
  <action>
Create CSS for the MsUpload bridge dropdown controls. Must visually integrate with MsUpload's plain DOM style (not OOUI).

**Selectors and rules:**

1. `.fileperm-msupload-controls` — Container for label + select:
   - `padding: 6px 8px;` — Match MsUpload's spacing
   - `border-bottom: 1px solid #c8ccd1;` — Subtle separator between controls and dropzone
   - `background: #f8f9fa;` — Light background matching MW surface color
   - `display: flex;`
   - `align-items: center;`
   - `gap: 8px;`

2. `.fileperm-msupload-controls label` — Label styling:
   - `font-weight: bold;`
   - `white-space: nowrap;`
   - `font-size: 0.9em;`

3. `#fileperm-msupload-select` — The select dropdown:
   - `padding: 4px 8px;`
   - `border: 1px solid #a2a9b1;` — MW standard border color
   - `border-radius: 2px;`
   - `font-size: 0.9em;`
   - `background: #fff;`

4. `#fileperm-msupload-select:disabled` — Disabled state during upload:
   - `opacity: 0.5;`
   - `cursor: not-allowed;`

5. `.fileperm-msupload-error` — Error state when levels can't load:
   - `padding: 8px;`
   - `color: #d33;` — MW error red
   - `font-size: 0.9em;`
   - `border-bottom: 1px solid #c8ccd1;`

Keep it minimal — match MsUpload's utilitarian visual style. No animations, no shadows, no rounded corners beyond 2px.
  </action>
  <verify>
1. Read the created file and verify all five selectors are present.
2. Verify disabled state styles exist for the select.
3. Verify error state styles exist.
4. File is valid CSS (no syntax errors — check for balanced braces).
  </verify>
  <done>
ext.FilePermissions.msupload.css created with styling for dropdown controls container, label, select element, disabled state, and error state. Visual style matches MsUpload's plain DOM aesthetic.
  </done>
</task>

</tasks>

<verification>
1. Both files exist: `ls modules/ext.FilePermissions.msupload.js modules/ext.FilePermissions.msupload.css`
2. JS file uses IIFE pattern: grep for `( function ()` at start
3. JS file hooks into plupload correctly: grep for `MsUpload.uploader.bind`
4. JS file does NOT use setOption: grep should return no matches for `setOption`
5. JS file uses memorized MW hook: grep for `mw.hook.*wikiEditor.toolbarReady`
6. JS file has post-upload verification: grep for `pageprops` or `fileperm_level`
7. JS file has error notification with autoHide false: grep for `autoHide`
8. CSS file has all required selectors: fileperm-msupload-controls, fileperm-msupload-select, fileperm-msupload-error
</verification>

<success_criteria>
- ext.FilePermissions.msupload.js: Dropdown builds from wgFilePermLevels, defaults from wgFilePermMsUploadDefault
- BeforeUpload handler adds wpFilePermLevel to uploader.settings.multipart_params (not setOption)
- FileUploaded handler verifies PageProps via API query and shows persistent error on failure
- StateChanged handler disables dropdown during upload
- Error state shown when levels config is unavailable
- Guards prevent errors when MsUpload is not initialized
- CSS provides clean integration with MsUpload's visual style
- Disabled state visually indicates dropdown is locked during upload
</success_criteria>

<output>
After completion, create `.planning/phases/05-msupload-integration/05-02-SUMMARY.md`
</output>
