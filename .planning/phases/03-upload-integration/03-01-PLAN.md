---
phase: 03-upload-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Hooks/UploadHooks.php
  - extension.json
  - i18n/en.json
autonomous: false

must_haves:
  truths:
    - "Permission dropdown appears on Special:Upload form"
    - "Dropdown lists all configured $wgFilePermLevels with group info"
    - "Dropdown starts empty with placeholder requiring selection"
    - "Re-upload pre-selects the file's current permission level"
    - "Upload is blocked if no permission level is selected"
    - "Uploaded file has selected permission level stored in PageProps"
  artifacts:
    - path: "includes/Hooks/UploadHooks.php"
      provides: "Upload form dropdown injection and permission storage on upload"
      contains: "UploadFormInitDescriptorHook"
    - path: "extension.json"
      provides: "Hook handler registration for upload hooks"
      contains: "UploadFormInitDescriptor"
    - path: "i18n/en.json"
      provides: "Upload form labels, help text, validation messages"
      contains: "filepermissions-upload-label"
  key_links:
    - from: "extension.json"
      to: "includes/Hooks/UploadHooks.php"
      via: "HookHandlers registration with service injection"
      pattern: "\"upload\".*UploadHooks"
    - from: "includes/Hooks/UploadHooks.php"
      to: "includes/PermissionService.php"
      via: "Constructor injection for getLevel/setLevel"
      pattern: "PermissionService"
    - from: "includes/Hooks/UploadHooks.php"
      to: "includes/Config.php"
      via: "Static calls for getLevels/getGroupGrants"
      pattern: "Config::getLevels|Config::getGroupGrants"
---

<objective>
Add a permission-level dropdown to MediaWiki's Special:Upload form and store the selected level in PageProps on upload completion.

Purpose: This is the first user-facing feature of FilePermissions. Without it, permission levels can only be set programmatically. This plan covers all four UPLD requirements: dropdown presence (UPLD-01), options from config (UPLD-02), default selection logic (UPLD-03), and storage on upload (UPLD-04).

Output: UploadHooks.php class, updated extension.json registration, updated i18n messages.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-upload-integration/03-RESEARCH.md
@.planning/phases/03-upload-integration/03-CONTEXT.md

@includes/Config.php
@includes/PermissionService.php
@includes/Hooks/EnforcementHooks.php
@includes/ServiceWiring.php
@extension.json
@i18n/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UploadHooks class and register hooks</name>
  <files>
    includes/Hooks/UploadHooks.php
    extension.json
    i18n/en.json
  </files>
  <action>
Create `includes/Hooks/UploadHooks.php` implementing `UploadFormInitDescriptorHook` and `UploadCompleteHook`.

Follow the EnforcementHooks pattern exactly: declare strict_types, namespace FilePermissions\Hooks, constructor-injected PermissionService.

**onUploadFormInitDescriptor method:**

1. Receive `&$descriptor` array. Add a new field keyed `'FilePermLevel'` (HTMLForm auto-prefixes with `wp`, so the form field name becomes `wpFilePermLevel`).

2. Build the options array from Config::getLevels() and Config::getGroupGrants():
   - Start with empty placeholder: `wfMessage('filepermissions-upload-choose')->text()` => `''`
   - For each level in Config::getLevels(), build label showing level name + granted groups in parentheses. Example: `"confidential (sysop, trusted-staff)"`. Use Config::getGroupGrants() to find which groups grant each level. If no groups grant a level, show just the level name.
   - Options array format for HTMLForm select: `[ 'label text' => 'value', ... ]`

3. Set field descriptor properties:
   - `'type' => 'select'`
   - `'label-message' => 'filepermissions-upload-label'`
   - `'help-message' => 'filepermissions-upload-help'`
   - `'options' => $options` (the array built above)
   - `'section' => 'description'` (places it in the description section of the upload form)
   - `'validation-callback'` => a callback that returns true if value is non-empty and a valid level via Config::isValidLevel(), otherwise returns wfMessage('filepermissions-upload-required')->text() for empty or wfMessage('filepermissions-upload-invalid')->text() for invalid values.

4. Handle re-upload default: Check if `$descriptor['DestFile']` exists (the destination filename field). Use RequestContext::getMain()->getRequest()->getVal('wpDestFile') to get the target filename. If a filename is provided, look up the existing file's permission level via PermissionService::getLevel(). If the level exists AND is still valid per Config::isValidLevel(), set `'default' => $existingLevel` on the descriptor. If the level is not valid (removed from config), do NOT set a default (force re-selection per CONTEXT.md).

**onUploadComplete method:**

1. Receive `UploadBase &$upload` parameter.
2. Get the uploaded file's local file: `$upload->getLocalFile()`.
3. Get the title from the local file: `$localFile->getTitle()`.
4. Guard: if `$localFile === null` or title's `getArticleID() === 0`, return early (file page not yet created).
5. Read the selected level from the request: `RequestContext::getMain()->getRequest()->getVal('wpFilePermLevel')`.
6. Guard: if level is empty or not valid via Config::isValidLevel(), return early (validation should have caught this, but defense in depth).
7. Store via `$this->permissionService->setLevel($title, $level)`.

**extension.json updates:**

Add to `HookHandlers`:
```json
"upload": {
    "class": "FilePermissions\\Hooks\\UploadHooks",
    "services": ["FilePermissions.PermissionService"]
}
```

Add to `Hooks`:
```json
"UploadFormInitDescriptor": "upload",
"UploadComplete": "upload"
```

**i18n/en.json updates:**

Add these messages (keep existing messages, add after them):
```json
"filepermissions-upload-label": "Permission level",
"filepermissions-upload-help": "Controls which groups can view this file.",
"filepermissions-upload-choose": "-- Choose --",
"filepermissions-upload-required": "You must select a permission level.",
"filepermissions-upload-invalid": "The selected permission level is not valid."
```

**Important notes:**
- Do NOT use `required => true` in the descriptor. The validation-callback handles required logic. Using both causes conflicts in HTMLForm.
- The UploadComplete hook parameter signature in MW 1.44 is `onUploadComplete( UploadBase &$upload )`. Import `MediaWiki\Hook\UploadCompleteHook` and `MediaWiki\Hook\UploadFormInitDescriptorHook`. If these hook interfaces are not in the `MediaWiki\Hook` namespace in 1.44, check the MW source and use the correct import path.
- Use `Title::makeTitleSafe( NS_FILE, $destFile )` to safely construct the title for re-upload lookup.
  </action>
  <verify>
1. `php -l includes/Hooks/UploadHooks.php` returns no syntax errors
2. `python3 -c "import json; json.load(open('extension.json'))"` validates JSON
3. `python3 -c "import json; json.load(open('i18n/en.json'))"` validates JSON
4. Grep confirms UploadHooks class implements both hook interfaces
5. Grep confirms extension.json has both hook registrations
6. Grep confirms all 5 i18n messages exist in en.json
  </verify>
  <done>
UploadHooks.php exists with both hook methods implemented. extension.json registers the upload hook handler with PermissionService injection and maps both UploadFormInitDescriptor and UploadComplete hooks. i18n/en.json contains all upload form messages. All files pass syntax/JSON validation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Permission level dropdown on Special:Upload form with validation and PageProps storage on upload completion.</what-built>
  <how-to-verify>
1. Navigate to Special:Upload in your MediaWiki instance
2. Verify a "Permission level" dropdown appears in the Description section
3. Verify the dropdown shows "-- Choose --" as first option (selected by default)
4. Verify all configured levels appear with group names in parentheses (e.g., "confidential (sysop)")
5. Try to upload a file without selecting a permission level -- form should block with validation error
6. Select a permission level and upload a file successfully
7. Verify the uploaded file has the permission level stored: check PageProps table for the file page (SELECT * FROM page_props WHERE pp_page = [file_page_id] AND pp_propname = 'fileperm_level')
8. Re-upload the same file via Special:Upload -- verify the dropdown pre-selects the existing permission level
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- UploadHooks.php has no syntax errors
- extension.json is valid JSON with both hook registrations
- i18n/en.json is valid JSON with all 5 upload messages
- The dropdown field is keyed as 'FilePermLevel' in the descriptor
- Validation callback rejects empty and invalid selections
- UploadComplete stores level via PermissionService::setLevel()
- Re-upload detection uses PermissionService::getLevel() for pre-selection
</verification>

<success_criteria>
1. Permission dropdown visible on Special:Upload form (UPLD-01)
2. Options populated from $wgFilePermLevels with group info (UPLD-02)
3. Empty placeholder as default, re-upload pre-selects existing level (UPLD-03)
4. UploadComplete hook stores selected level in PageProps (UPLD-04)
5. Upload blocked without permission level selection
</success_criteria>

<output>
After completion, create `.planning/phases/03-upload-integration/03-01-SUMMARY.md`
</output>
