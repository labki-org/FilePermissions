---
phase: 08-integration-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/phpunit/integration/UploadHooksTest.php
  - tests/phpunit/integration/ApiFilePermTest.php
autonomous: true

must_haves:
  truths:
    - "UploadHooks UploadVerifyUpload rejects uploads with invalid permission levels"
    - "UploadHooks UploadComplete stores the selected permission level in fileperm_levels table"
    - "UploadHooks allows uploads with valid levels and stores them correctly"
    - "ApiFilePermSetLevel sets permission level when called by authorized sysop user"
    - "ApiFilePermSetLevel denies permission changes from non-sysop users"
    - "ApiQueryFilePermLevel returns correct permission level for queried files"
    - "API set-level requires CSRF token and POST method"
    - "All test classes use @group Database and fetch services fresh per test"
  artifacts:
    - path: "tests/phpunit/integration/UploadHooksTest.php"
      provides: "Integration tests for upload verification and completion hooks (INTG-04, INTG-05)"
      min_lines: 100
    - path: "tests/phpunit/integration/ApiFilePermTest.php"
      provides: "Integration tests for API set-level and query modules (INTG-06, INTG-07, INTG-08)"
      min_lines: 100
  key_links:
    - from: "tests/phpunit/integration/UploadHooksTest.php"
      to: "includes/Hooks/UploadHooks.php"
      via: "Direct instantiation with real PermissionService"
      pattern: "UploadHooks"
    - from: "tests/phpunit/integration/UploadHooksTest.php"
      to: "includes/PermissionService.php"
      via: "Service container for DB verification after upload"
      pattern: "FilePermissions\\.PermissionService"
    - from: "tests/phpunit/integration/ApiFilePermTest.php"
      to: "includes/Api/ApiFilePermSetLevel.php"
      via: "MW API test framework doApiRequestWithToken"
      pattern: "fileperm-set-level"
    - from: "tests/phpunit/integration/ApiFilePermTest.php"
      to: "includes/Api/ApiQueryFilePermLevel.php"
      via: "MW API test framework doApiRequest with prop=fileperm"
      pattern: "prop.*fileperm"
---

<objective>
Implement integration tests for UploadHooks (verification and completion) and API modules (set-level and query) within the MediaWiki runtime.

Purpose: Proves that upload validation rejects invalid permission levels and stores valid levels in fileperm_levels on completion (INTG-04, INTG-05), and that the API enforces sysop authorization for set-level while correctly returning levels via query (INTG-06, INTG-07, INTG-08).

Output: Two integration test files covering the upload and API layers of the permission system.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/Hooks/UploadHooks.php
@includes/Api/ApiFilePermSetLevel.php
@includes/Api/ApiQueryFilePermLevel.php
@includes/PermissionService.php
@includes/Config.php
@includes/ServiceWiring.php
@extension.json
@sql/tables.json
@tests/phpunit/unit/PermissionServiceTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement UploadHooks integration tests</name>
  <files>tests/phpunit/integration/UploadHooksTest.php</files>
  <action>
Create tests/phpunit/integration/UploadHooksTest.php extending MediaWikiIntegrationTestCase.

**Namespace:** `FilePermissions\Tests\Integration`

**Class annotations:**
- `@covers \FilePermissions\Hooks\UploadHooks`
- `@group Database`

**Critical integration test rules:**
1. Get PermissionService from service container. Construct UploadHooks with it: `new UploadHooks($permissionService)`.
2. Override all 5 config vars in setUp() via overrideConfigValue.
3. Reset service between tests for cache poisoning prevention.
4. UploadHooks reads `wpFilePermLevel` from RequestContext's WebRequest. To simulate this:
   - Create a FauxRequest with the desired parameters: `new FauxRequest(['wpFilePermLevel' => 'confidential'])` (or omit the param to simulate no selection)
   - Set it on RequestContext: `RequestContext::getMain()->setRequest($fauxRequest)`
5. For onUploadVerifyUpload, mock the UploadBase parameter. The hook only uses the $user and $error params for validation logic (UploadBase itself is not deeply inspected). Pass a mock UploadBase, the test user, null props, empty comment, empty pageText, and capture $error by reference.
6. For onUploadComplete, you need a real file page in the DB. The hook reads from UploadBase->getLocalFile()->getTitle(). The simplest approach:
   - Create a File: page via insertPage
   - Mock UploadBase with getLocalFile() returning a mock LocalFile
   - Mock LocalFile with getTitle() returning the real Title from insertPage
   - After calling onUploadComplete, run DeferredUpdates::doUpdates() to execute the deferred callback
   - Then verify with PermissionService->getLevel() that the level was stored
7. Restore original request in tearDown.

**INTG-04 -- UploadVerifyUpload rejection tests:**
- `testRejectsUploadWithInvalidPermissionLevel`: Set wpFilePermLevel to 'nonexistent-level'. Call onUploadVerifyUpload. Assert returns false and $error = ['filepermissions-upload-invalid'].
- `testRejectsUploadWithMissingLevelWhenNoDefault`: No wpFilePermLevel in request, wgFilePermDefaultLevel = null, and request has wpUploadFile param (simulating an actual upload). Assert returns false and $error = ['filepermissions-upload-required'].
- `testAcceptsUploadWithValidPermissionLevel`: Set wpFilePermLevel to 'internal'. Assert returns true and $error is unchanged (still the initial value).
- `testAcceptsUploadWithMissingLevelWhenDefaultConfigured`: No wpFilePermLevel, but wgFilePermDefaultLevel = 'public'. Assert returns true (default will be applied on completion).
- `testAcceptsUploadWithEmptyLevelWhenDefaultConfigured`: wpFilePermLevel = '' (empty string), wgFilePermDefaultLevel = 'public'. Assert returns true.

**INTG-05 -- UploadComplete storage tests:**
- `testStoresPermissionLevelOnUploadComplete`: Set wpFilePermLevel = 'confidential' in request. Create File: page, mock UploadBase chain. Call onUploadComplete, then DeferredUpdates::doUpdates(). Verify PermissionService->getLevel($title) returns 'confidential'.
- `testStoresDefaultLevelWhenNoExplicitSelection`: No wpFilePermLevel, wgFilePermDefaultLevel = 'public'. Call onUploadComplete + doUpdates. Verify level is 'public'.
- `testDoesNotStoreLevelWhenUploadHasNoLocalFile`: Mock UploadBase->getLocalFile() returns null. Call onUploadComplete. No error thrown, no level stored.
- `testDoesNotStoreLevelWhenTitleIsNull`: Mock getLocalFile() returns LocalFile with getTitle() returning null. No error thrown.
- `testDoesNotStoreInvalidLevel`: Set wpFilePermLevel = 'nonexistent'. Call onUploadComplete + doUpdates. PermissionService->getLevel returns null (invalid level silently skipped in completion, caught in verification).

**Helper methods:**
- `getService()` -- reset and fetch fresh PermissionService
- `createMockUploadBase(Title $title)` -- returns mock UploadBase with getLocalFile chain
- `setRequestParams(array $params)` -- creates FauxRequest and sets on RequestContext

**RequestContext management:** Save and restore both the user AND request in setUp/tearDown.
  </action>
  <verify>
1. File exists at tests/phpunit/integration/UploadHooksTest.php
2. Class extends MediaWikiIntegrationTestCase
3. Namespace is FilePermissions\Tests\Integration
4. Has `@group Database` annotation
5. Uses real PermissionService from service container
6. FauxRequest used to simulate wpFilePermLevel parameter
7. setUp() overrides all 5 config vars
8. At least 10 test methods covering INTG-04 and INTG-05
9. INTG-04: Invalid level rejected with specific error message
10. INTG-05: DeferredUpdates::doUpdates() called after onUploadComplete
11. INTG-05: PermissionService->getLevel() verifies DB persistence after upload
12. tearDown restores original RequestContext request and user
  </verify>
  <done>UploadHooksTest.php covers INTG-04 (UploadVerifyUpload rejects invalid levels, accepts valid levels, handles missing level with/without default) and INTG-05 (UploadComplete stores level in fileperm_levels via DeferredUpdates, handles null file/title gracefully, applies default level). All tests use real DB, real service container, FauxRequest for parameter simulation.</done>
</task>

<task type="auto">
  <name>Task 2: Implement API module integration tests</name>
  <files>tests/phpunit/integration/ApiFilePermTest.php</files>
  <action>
Create tests/phpunit/integration/ApiFilePermTest.php extending ApiTestCase.

**Namespace:** `FilePermissions\Tests\Integration`

**Class annotations:**
- `@covers \FilePermissions\Api\ApiFilePermSetLevel`
- `@covers \FilePermissions\Api\ApiQueryFilePermLevel`
- `@group Database`
- `@group API`

**Why ApiTestCase:** MediaWiki's ApiTestCase provides `doApiRequest()` and `doApiRequestWithToken()` methods that simulate real API calls through the MW API framework. This tests the full stack: parameter parsing, permission checks, token validation, module execution, and result formatting.

**Critical integration test rules:**
1. Override all 5 config vars in setUp() via overrideConfigValue.
2. Create test users with specific rights:
   - Sysop user (has edit-fileperm right): `$this->getTestSysop()`
   - Regular user (no edit-fileperm right): `$this->getTestUser()`
3. Create File: pages with `$this->insertPage()` for API targets.
4. For set-level API: use `doApiRequestWithToken('csrf', [...], null, $sysopSession)` which handles CSRF token automatically.
5. For query API: use `doApiRequest(['action' => 'query', 'prop' => 'fileperm', 'titles' => 'File:Test.png'])`.
6. After set-level API calls, verify the level persisted by fetching PermissionService from container and calling getLevel.

**INTG-06 -- ApiFilePermSetLevel authorized usage:**
- `testSetLevelSucceedsForSysopUser`: Create File: page. Call fileperm-set-level API as sysop with valid level. Assert API response has result=success and level matches. Verify with PermissionService->getLevel() that DB was updated.
- `testSetLevelOverwritesExistingLevel`: Set level to 'public' via API, then set to 'confidential' via API. Verify final level is 'confidential'.
- `testSetLevelRejectsNonexistentPage`: Call API with title='File:DoesNotExist.png'. Assert API error (filepermissions-api-nosuchpage or equivalent).
- `testSetLevelRejectsInvalidLevel`: Call API with level='nonexistent'. Assert API error about invalid parameter value.

**INTG-07 -- ApiFilePermSetLevel authorization denial:**
- `testSetLevelDeniedForRegularUser`: Create File: page. Call fileperm-set-level API as regular user (no edit-fileperm right). Assert API error with 'permissiondenied' code or 'badaccess-groups' error.
- `testSetLevelDeniedForAnonymousUser`: Attempt API call without authentication. Assert permission denied (MW blocks API writes from anon).
- `testSetLevelRequiresPostMethod`: Attempt GET request to fileperm-set-level. Assert error about POST requirement (mustBePosted).
- `testSetLevelRequiresCsrfToken`: Call API without CSRF token (use doApiRequest instead of doApiRequestWithToken). Assert error about missing/invalid token.

**INTG-08 -- ApiQueryFilePermLevel tests:**
- `testQueryReturnsPermissionLevelForProtectedFile`: Create File: page, set level via PermissionService. Query API with prop=fileperm for that page. Assert response includes fileperm_level with correct value.
- `testQueryOmitsLevelForUnprotectedFile`: Create File: page without setting level. Query API. Assert fileperm_level is absent from response (not null, just absent).
- `testQueryReturnsLevelsForMultiplePages`: Create two File: pages with different levels. Query both. Assert each page in response has correct level.
- `testQueryWorksForAnyAuthenticatedUser`: Regular user (non-sysop) queries fileperm levels. Assert success -- reading levels is public, not restricted to sysop.

**Important MW API testing patterns:**
- `doApiRequestWithToken('csrf', $params)` automatically adds the token. The first array element should have 'action' => 'fileperm-set-level'.
- For sysop requests: pass the sysop session. Use `$sysop = $this->getTestSysop()` then `$session = $sysop->getUser()->getRequest()->getSession()` or pass $sysop as performer.
- For regular user requests: use `$this->getTestUser()`.
- API responses are `[array $data, WebRequest $request]`. Check `$data['fileperm-set-level']['result']` for set-level, and `$data['query']['pages']` for query.
- When testing permission denials, wrap in try/catch for ApiUsageException or check the error array in the response.
  </action>
  <verify>
1. File exists at tests/phpunit/integration/ApiFilePermTest.php
2. Class extends ApiTestCase
3. Namespace is FilePermissions\Tests\Integration
4. Has `@group Database` and `@group API` annotations
5. setUp() overrides all 5 config vars
6. Uses getTestSysop() for authorized API calls
7. Uses getTestUser() for unauthorized API calls
8. At least 12 test methods covering INTG-06, INTG-07, INTG-08
9. INTG-06: Set-level API persists level (verified via PermissionService)
10. INTG-07: Non-sysop users get permission denied error
11. INTG-07: Missing CSRF token rejected
12. INTG-08: Query returns correct levels for protected files
13. INTG-08: Query works for non-sysop users (read access is public)
  </verify>
  <done>ApiFilePermTest.php covers INTG-06 (sysop can set levels via API, persisted to DB), INTG-07 (non-sysop denied, CSRF token required, POST required), INTG-08 (query returns correct levels, works for any authenticated user, handles multiple pages). All tests use MW ApiTestCase framework with real API dispatch, real DB, and real permission checks.</done>
</task>

</tasks>

<verification>
1. tests/phpunit/integration/UploadHooksTest.php exists with @group Database, extends MediaWikiIntegrationTestCase
2. tests/phpunit/integration/ApiFilePermTest.php exists with @group Database and @group API, extends ApiTestCase
3. Both files use FilePermissions\Tests\Integration namespace
4. Both use overrideConfigValue for all 5 FilePermissions config vars
5. UploadHooksTest: FauxRequest simulates form parameters, DeferredUpdates executed, DB verified
6. ApiFilePermTest: doApiRequestWithToken for write operations, doApiRequest for queries
7. Authorization denial tested for non-sysop users (INTG-07)
8. Query endpoint accessible to non-sysop users (INTG-08)
9. All tests use fresh service instances (cache poisoning prevention)
10. 10+ upload tests, 12+ API tests
</verification>

<success_criteria>
- UploadHooksTest covers INTG-04 (invalid level rejection) and INTG-05 (level storage on upload completion)
- ApiFilePermTest covers INTG-06 (authorized set-level), INTG-07 (unauthorized denial), INTG-08 (level query)
- Upload tests verify DB persistence via PermissionService after DeferredUpdates
- API tests use MW ApiTestCase framework (real API dispatch, not mocked)
- Authorization checks tested: sysop succeeds, regular user denied, CSRF token required
- All integration tests use @group Database and real DB operations
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-tests/08-02-SUMMARY.md`
</output>
