---
phase: 08-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/phpunit/integration/PermissionServiceDbTest.php
  - tests/phpunit/integration/EnforcementHooksTest.php
autonomous: true

must_haves:
  truths:
    - "PermissionService setLevel writes to fileperm_levels table and getLevel reads it back"
    - "PermissionService removeLevel deletes from fileperm_levels table and getLevel returns null"
    - "PermissionService in-process cache returns correct values after set/get/remove round-trip"
    - "Fresh PermissionService instances do not share cache state (no cross-scenario poisoning)"
    - "EnforcementHooks getUserPermissionsErrors denies unauthorized user access to a protected File: page"
    - "EnforcementHooks ImgAuthBeforeStream denies unauthorized file download and returns img-auth-accessdenied result"
    - "EnforcementHooks ImageBeforeProduceHTML replaces protected image with placeholder HTML for unauthorized user"
    - "All authorized users pass through enforcement hooks without denial"
  artifacts:
    - path: "tests/phpunit/integration/PermissionServiceDbTest.php"
      provides: "DB round-trip integration tests for PermissionService (INTG-09, INTG-10)"
      min_lines: 100
    - path: "tests/phpunit/integration/EnforcementHooksTest.php"
      provides: "Integration tests for all 3 enforcement hooks (INTG-01, INTG-02, INTG-03)"
      min_lines: 150
  key_links:
    - from: "tests/phpunit/integration/PermissionServiceDbTest.php"
      to: "includes/PermissionService.php"
      via: "MediaWikiServices::getInstance()->getService('FilePermissions.PermissionService')"
      pattern: "getService.*FilePermissions\\.PermissionService"
    - from: "tests/phpunit/integration/PermissionServiceDbTest.php"
      to: "sql/tables.json"
      via: "@group Database triggers table creation"
      pattern: "@group Database"
    - from: "tests/phpunit/integration/EnforcementHooksTest.php"
      to: "includes/Hooks/EnforcementHooks.php"
      via: "Direct instantiation with real PermissionService from service container"
      pattern: "EnforcementHooks"
    - from: "tests/phpunit/integration/EnforcementHooksTest.php"
      to: "includes/PermissionService.php"
      via: "Service container wiring"
      pattern: "FilePermissions\\.PermissionService"
---

<objective>
Implement integration tests for PermissionService database operations and EnforcementHooks within the MediaWiki runtime.

Purpose: Proves that PermissionService correctly round-trips permission levels through the real fileperm_levels table (INTG-09, INTG-10), and that all three enforcement hooks (getUserPermissionsErrors, ImgAuthBeforeStream, ImageBeforeProduceHTML) correctly deny unauthorized users and allow authorized users when running against real MW services (INTG-01, INTG-02, INTG-03).

Output: Two integration test files covering the data layer and enforcement layer of the permission system.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/PermissionService.php
@includes/Hooks/EnforcementHooks.php
@includes/Config.php
@includes/ServiceWiring.php
@extension.json
@sql/tables.json
@tests/phpunit/unit/PermissionServiceTest.php
@tests/phpunit/unit/ConfigTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PermissionService database integration tests</name>
  <files>tests/phpunit/integration/PermissionServiceDbTest.php</files>
  <action>
Create tests/phpunit/integration/PermissionServiceDbTest.php extending MediaWikiIntegrationTestCase.

**Namespace:** `FilePermissions\Tests\Integration`

**Class annotations:**
- `@covers \FilePermissions\PermissionService`
- `@group Database`

**Critical integration test rules:**
1. Get PermissionService from the service container via `$this->getServiceContainer()->getService('FilePermissions.PermissionService')` -- do NOT construct manually. This proves the ServiceWiring works.
2. Get a FRESH service instance per test method. Call `$this->getServiceContainer()->resetServiceForTesting('FilePermissions.PermissionService')` in setUp() to clear the singleton, then fetch a new instance per test. This prevents cache poisoning across tests.
3. Override all 5 FilePermissions config vars in setUp() using `$this->overrideConfigValue()`:
   - `wgFilePermLevels` => `['public', 'internal', 'confidential']`
   - `wgFilePermGroupGrants` => `['sysop' => ['*'], 'editor' => ['public', 'internal'], 'viewer' => ['public']]`
   - `wgFilePermDefaultLevel` => `null`
   - `wgFilePermNamespaceDefaults` => `[]`
   - `wgFilePermInvalidConfig` => `false`
4. Create real File: pages using `$this->insertPage('File:TestImage.png', 'test content', NS_FILE)`. This returns a page record with a real page ID that PermissionService can use.
5. The `@group Database` annotation ensures MW creates/drops the fileperm_levels table for each test class.

**Required test coverage (INTG-09):**

setLevel/getLevel round-trip:
- `testSetLevelAndGetLevelRoundTrip`: Insert a File: page, call `setLevel($title, 'confidential')`, then `getLevel($title)` returns `'confidential'`. Assert the value matches exactly.
- `testSetLevelOverwritesPreviousLevel`: Set level to 'public', then set to 'confidential'. getLevel returns 'confidential' (REPLACE semantics).
- `testGetLevelReturnsNullWhenNoLevelSet`: Insert a File: page but never call setLevel. getLevel returns null.
- `testRemoveLevelDeletesFromDatabase`: Set level, then removeLevel. getLevel returns null.
- `testRemoveLevelOnPageWithNoLevelIsNoOp`: removeLevel on a page that never had a level does not throw.
- `testSetLevelThrowsForNonexistentPage`: Call setLevel on a Title with articleID 0. Expect InvalidArgumentException.
- `testSetLevelThrowsForInvalidLevel`: Call setLevel with 'nonexistent-level'. Expect InvalidArgumentException.
- `testGetLevelReturnsNullForNonFileNamespace`: Insert a regular page (NS_MAIN), call getLevel. Returns null.

**Required test coverage (INTG-10):**

Cache behavior with real DB:
- `testCacheReturnsCorrectValueAfterSet`: Set level, get level (cached), verify no second DB query needed. Use a fresh service to prove the cache is populated by set.
- `testFreshServiceInstanceDoesNotShareCache`: Service A sets level and caches it. Reset service via `resetServiceForTesting`. Service B (fresh) calls getLevel -- must still return correct value (reads from DB, not stale cache). This proves no cross-scenario cache poisoning.
- `testCacheReflectsRemoval`: Set level, get level (populates cache), remove level, get level again on SAME instance. Must return null, proving cache is updated on remove.
- `testMultiplePagesHaveIndependentCacheEntries`: Set different levels on two different File: pages. getLevel for each returns the correct level independently.

**Helper method:** `getService()` -- calls resetServiceForTesting then getService to ensure fresh instance per call.

**Important:** Do NOT use `$this->db->insert()` directly for fileperm_levels. Always go through PermissionService methods. The point is testing the service, not raw SQL.
  </action>
  <verify>
1. File exists at tests/phpunit/integration/PermissionServiceDbTest.php
2. Class extends MediaWikiIntegrationTestCase
3. Namespace is FilePermissions\Tests\Integration
4. Has `@group Database` annotation
5. Uses getServiceContainer()->getService() (not manual construction)
6. setUp() overrides all 5 config vars via overrideConfigValue
7. At least 12 test methods covering INTG-09 and INTG-10
8. Round-trip test proves setLevel data persists and getLevel reads it back
9. Cache poisoning test uses resetServiceForTesting between service instances
10. No direct DB access -- all operations through PermissionService methods
  </verify>
  <done>PermissionServiceDbTest.php covers INTG-09 (setLevel/getLevel/removeLevel round-trip through fileperm_levels table) and INTG-10 (in-process cache returns correct values, fresh instances do not share cache). All tests use real DB via @group Database, services fetched from container, config overridden via overrideConfigValue, and fresh service per test prevents cache poisoning.</done>
</task>

<task type="auto">
  <name>Task 2: Implement EnforcementHooks integration tests</name>
  <files>tests/phpunit/integration/EnforcementHooksTest.php</files>
  <action>
Create tests/phpunit/integration/EnforcementHooksTest.php extending MediaWikiIntegrationTestCase.

**Namespace:** `FilePermissions\Tests\Integration`

**Class annotations:**
- `@covers \FilePermissions\Hooks\EnforcementHooks`
- `@group Database`

**Critical integration test rules:**
1. Get PermissionService from service container (same pattern as Task 1).
2. Construct EnforcementHooks with the real PermissionService: `new EnforcementHooks($permissionService)`. This tests the actual hook logic with real DB-backed permission lookups.
3. Override all 5 config vars in setUp() via overrideConfigValue.
4. Create test users with specific groups:
   - Use `$this->getTestUser(['sysop'])` for a user with wildcard access
   - Use `$this->getTestUser(['editor'])` for a user with partial access (public + internal)
   - Use `$this->getTestUser([])` for a user with NO file permission groups (but still a valid user)
5. Set RequestContext user explicitly before calling hooks that read it:
   - `RequestContext::getMain()->setUser($testUser->getUser())`
   - ImgAuthBeforeStream and ImageBeforeProduceHTML read from RequestContext, not from parameters
6. Create File: pages with `$this->insertPage()` and set permission levels via PermissionService.
7. Reset service between tests to prevent cache poisoning.

**INTG-01 -- getUserPermissionsErrors tests:**
- `testDeniesUnauthorizedUserAccessToProtectedFilePage`: Create File: page, set level 'confidential'. Call onGetUserPermissionsErrors with a 'viewer' user (only has 'public'). Assert returns false and $result = ['filepermissions-access-denied'].
- `testAllowsAuthorizedUserAccessToProtectedFilePage`: Same setup but with 'sysop' user. Assert returns true and $result is unchanged.
- `testAllowsAccessToFilePageWithNoPermissionLevel`: File: page with no level set. Any user can access. Returns true.
- `testIgnoresNonFileNamespace`: Title with NS_MAIN. Hook returns true regardless (skips check).
- `testIgnoresNonReadAction`: File: title with 'edit' action. Hook returns true (only checks 'read').
- `testDeniesAccessWhenConfigInvalid_FailClosed`: Set wgFilePermInvalidConfig to true. Any user denied access to any File: page with a level.

**INTG-02 -- ImgAuthBeforeStream tests:**
- `testDeniesUnauthorizedFileDownload`: Create protected file, set RequestContext to unauthorized user. Call onImgAuthBeforeStream. Assert returns false and $result = ['img-auth-accessdenied', 'filepermissions-img-denied'].
- `testAllowsAuthorizedFileDownload`: Same but authorized user. Returns true, $result unchanged.
- `testAllowsDownloadOfUnprotectedFile`: File with no level. Returns true for any user.

**INTG-03 -- ImageBeforeProduceHTML tests:**
- `testReplacesProtectedImageWithPlaceholderForUnauthorizedUser`: Create protected file, set RequestContext to unauthorized user. Call onImageBeforeProduceHTML. Assert returns false and $res contains 'fileperm-placeholder' CSS class.
- `testAllowsEmbeddingForAuthorizedUser`: Same but authorized user. Returns true, $res unchanged.
- `testPlaceholderContainsSvgLockIcon`: When blocked, $res includes 'data:image/svg+xml' (the lock icon SVG).
- `testPlaceholderUsesProvidedDimensions`: Pass width=300, height=200 in handlerParams. Placeholder HTML contains 'width:300px' and 'height:200px'.
- `testDisablesParserCacheForProtectedImages`: When a file has a permission level, check that parser output cache expiry is set to 0. Create a mock parser with getOutput() returning a mock ParserOutput, verify `updateCacheExpiry(0)` is called.

**Helper methods:**
- `getService()` -- reset and fetch fresh PermissionService
- `createProtectedFile(string $name, string $level)` -- insertPage + setLevel, returns Title
- `createUnprotectedFile(string $name)` -- insertPage only, returns Title

**RequestContext management:** In tearDown, restore the original RequestContext user to prevent cross-test pollution:
```php
private $originalUser;
protected function setUp(): void {
    parent::setUp();
    $this->originalUser = RequestContext::getMain()->getUser();
}
protected function tearDown(): void {
    RequestContext::getMain()->setUser($this->originalUser);
    parent::tearDown();
}
```
  </action>
  <verify>
1. File exists at tests/phpunit/integration/EnforcementHooksTest.php
2. Class extends MediaWikiIntegrationTestCase
3. Namespace is FilePermissions\Tests\Integration
4. Has `@group Database` annotation
5. Uses real PermissionService from service container
6. EnforcementHooks constructed with real PermissionService
7. setUp() overrides all 5 config vars
8. Test users created with getTestUser() with specific groups
9. RequestContext user set explicitly before ImgAuthBeforeStream and ImageBeforeProduceHTML calls
10. At least 14 test methods covering INTG-01, INTG-02, INTG-03
11. Deny tests verify exact error message arrays
12. Placeholder test verifies fileperm-placeholder class and SVG data URI
13. tearDown restores original RequestContext user
  </verify>
  <done>EnforcementHooksTest.php covers INTG-01 (getUserPermissionsErrors denies/allows based on level+group), INTG-02 (ImgAuthBeforeStream denies unauthorized downloads), INTG-03 (ImageBeforeProduceHTML replaces with placeholder). All hooks tested with real DB-backed PermissionService, real test users with specific groups, explicit RequestContext user injection, fail-closed behavior verified, and authorized user pass-through confirmed.</done>
</task>

</tasks>

<verification>
1. tests/phpunit/integration/PermissionServiceDbTest.php exists with @group Database, extends MediaWikiIntegrationTestCase
2. tests/phpunit/integration/EnforcementHooksTest.php exists with @group Database, extends MediaWikiIntegrationTestCase
3. Both files use FilePermissions\Tests\Integration namespace
4. Both use overrideConfigValue for all 5 FilePermissions config vars
5. Both get PermissionService from service container (not manual construction)
6. Both use fresh service instances per test (cache poisoning prevention)
7. EnforcementHooksTest sets RequestContext user explicitly
8. 12+ tests for DB round-trip, 14+ tests for enforcement hooks
9. Deny scenarios verify exact error messages/arrays
10. Allow scenarios confirm hooks return true without modifying result
</verification>

<success_criteria>
- PermissionServiceDbTest covers INTG-09 (full DB round-trip) and INTG-10 (cache behavior with real DB)
- EnforcementHooksTest covers INTG-01 (File: page access), INTG-02 (img_auth download), INTG-03 (image embedding placeholder)
- All integration tests use real MW services and DB (not mocks)
- Service container wiring (ServiceWiring.php) is exercised
- Cache poisoning between tests is provably prevented
- Fail-closed behavior tested with real services
- Authorized user pass-through tested for every hook
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-tests/08-01-SUMMARY.md`
</output>
