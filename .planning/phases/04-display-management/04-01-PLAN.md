---
phase: 04-display-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Hooks/DisplayHooks.php
  - includes/Api/ApiFilePermSetLevel.php
  - extension.json
  - i18n/en.json
autonomous: true

must_haves:
  truths:
    - "Permission level indicator appears on File: description pages for files with a level"
    - "Sysop users see an OOUI dropdown + save button below the indicator"
    - "Non-sysop users see only the indicator, not the edit controls"
    - "API endpoint fileperm-set-level accepts title + level, validates, stores via PermissionService, and logs the change"
    - "Permission changes are logged to Special:Log/fileperm"
  artifacts:
    - path: "includes/Hooks/DisplayHooks.php"
      provides: "ImagePageAfterImageLinks + BeforePageDisplay hook handlers"
      contains: "onImagePageAfterImageLinks"
    - path: "includes/Api/ApiFilePermSetLevel.php"
      provides: "Custom API module for permission saves"
      contains: "class ApiFilePermSetLevel extends ApiBase"
    - path: "extension.json"
      provides: "Hook, API, RL module, rights, and log type registration"
      contains: "fileperm-set-level"
    - path: "i18n/en.json"
      provides: "Display, edit, and log i18n messages"
      contains: "filepermissions-level-label"
  key_links:
    - from: "includes/Hooks/DisplayHooks.php"
      to: "includes/PermissionService.php"
      via: "constructor DI"
      pattern: "PermissionService"
    - from: "includes/Api/ApiFilePermSetLevel.php"
      to: "includes/PermissionService.php"
      via: "constructor DI from ServiceWiring"
      pattern: "PermissionService"
    - from: "extension.json"
      to: "includes/Hooks/DisplayHooks.php"
      via: "HookHandlers registration"
      pattern: "FilePermissions\\\\Hooks\\\\DisplayHooks"
    - from: "extension.json"
      to: "includes/Api/ApiFilePermSetLevel.php"
      via: "APIModules registration"
      pattern: "FilePermissions\\\\Api\\\\ApiFilePermSetLevel"
---

<objective>
Create the backend infrastructure for displaying file permissions and editing them on File: description pages.

Purpose: This plan creates the PHP hooks, API endpoint, extension registration, and i18n messages that power the permission indicator display and sysop edit interface. The frontend JS/CSS module (Plan 02) depends on these artifacts.

Output: DisplayHooks.php (ImagePageAfterImageLinks + BeforePageDisplay), ApiFilePermSetLevel.php (CSRF-protected API), updated extension.json (hooks, API, rights, log type, RL module shell), updated i18n/en.json (all new messages).
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-display-management/04-RESEARCH.md

@includes/PermissionService.php
@includes/Config.php
@includes/ServiceWiring.php
@includes/Hooks/EnforcementHooks.php
@includes/Hooks/UploadHooks.php
@extension.json
@i18n/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DisplayHooks and ApiFilePermSetLevel</name>
  <files>
    includes/Hooks/DisplayHooks.php
    includes/Api/ApiFilePermSetLevel.php
  </files>
  <action>
Create two new PHP files:

**DisplayHooks.php** (`includes/Hooks/DisplayHooks.php`):
- Namespace: `FilePermissions\Hooks`
- Constructor-injected dependency: `PermissionService $permissionService`
- Implement `ImagePageAfterImageLinksHook` interface:
  - `onImagePageAfterImageLinks( $imagePage, &$html )`:
    - Get `$title` from `$imagePage->getTitle()`
    - Get `$level` via `$this->permissionService->getLevel( $title )`
    - If `$level === null`, return early (no indicator for files without a level)
    - Get `$out` and `$user` from `$imagePage->getContext()`
    - Build indicator HTML: a `div.fileperm-section` containing:
      - `div.fileperm-indicator` with bold label (`filepermissions-level-label` i18n message) + `span.fileperm-level-badge#fileperm-level-badge` showing the level text
      - If `$user->isAllowed( 'edit-fileperm' )`: also render OOUI edit controls
    - For the edit controls (sysop only):
      - Call `$out->enableOOUI()` to ensure OOUI styles load
      - Build `\OOUI\DropdownInputWidget` with id `fileperm-edit-dropdown`, options from `Config::getLevels()`, value set to current level
      - Build `\OOUI\ButtonInputWidget` with id `fileperm-edit-save`, label from i18n `filepermissions-edit-save`, flags `['primary', 'progressive']`, type `'button'`
      - Wrap in `div.fileperm-edit-controls#fileperm-edit-controls`
    - Append the complete section HTML to `$html`

- Implement `BeforePageDisplayHook` interface:
  - `onBeforePageDisplay( $out, $skin ): void`:
    - Get `$title` from `$out->getTitle()`
    - If `!$title` or `$title->getNamespace() !== NS_FILE`, return early
    - Always add module styles: `$out->addModuleStyles( [ 'ext.FilePermissions.indicator' ] )`
    - If `$out->getUser()->isAllowed( 'edit-fileperm' )`:
      - `$out->addModules( [ 'ext.FilePermissions.edit' ] )`
      - `$out->addJsConfigVars( [ 'wgFilePermCurrentLevel' => ..., 'wgFilePermLevels' => Config::getLevels(), 'wgFilePermPageTitle' => $title->getPrefixedDBkey() ] )`
      - To get current level: use `$this->permissionService->getLevel( $title )` (may be null)

Use `Html::rawElement` and `Html::element` from `MediaWiki\Html\Html` for all HTML generation. Use `wfMessage()` for i18n strings.

Follow the patterns in EnforcementHooks.php and UploadHooks.php for class structure and DI conventions.

**ApiFilePermSetLevel.php** (`includes/Api/ApiFilePermSetLevel.php`):
- Namespace: `FilePermissions\Api`
- Extend `ApiBase` (from `MediaWiki\Api\ApiBase` in MW 1.44, fall back to root `\ApiBase` if needed)
- Constructor: `__construct( $mainModule, $moduleName, PermissionService $permissionService )` -- call `parent::__construct( $mainModule, $moduleName )`
- `execute()`:
  - `$this->checkUserRightsAny( 'edit-fileperm' )` -- gate on custom right
  - Extract params via `$this->extractRequestParams()`
  - Create Title from `$params['title']` in NS_FILE
  - Validate title exists -- if not, `$this->dieWithError( 'filepermissions-api-nosuchpage' )`
  - Get old level via `$this->permissionService->getLevel( $title )`
  - Set new level via `$this->permissionService->setLevel( $title, $params['level'] )`
  - Create `ManualLogEntry( 'fileperm', 'change' )`:
    - `setPerformer( $this->getUser() )`
    - `setTarget( $title )`
    - `setParameters( [ '4::oldlevel' => $oldLevel ?? '(none)', '5::newlevel' => $newLevel ] )`
    - `$logid = $logEntry->insert()` then `$logEntry->publish( $logid )`
  - Return success: `$this->getResult()->addValue( null, $this->getModuleName(), [ 'result' => 'success', 'level' => $newLevel ] )`
- `needsToken()`: return `'csrf'` (string, not bool)
- `mustBePosted()`: return `true`
- `isWriteMode()`: return `true`
- `getAllowedParams()`: title (string, required), level (type from `Config::getLevels()`, required)

IMPORTANT: Use `ManualLogEntry` from root namespace or `MediaWiki\Logging\ManualLogEntry` depending on MW 1.44. Check EnforcementHooks.php for import conventions.
  </action>
  <verify>
Run `php -l includes/Hooks/DisplayHooks.php && php -l includes/Api/ApiFilePermSetLevel.php` -- both files must pass syntax check with no errors.
  </verify>
  <done>
DisplayHooks.php implements ImagePageAfterImageLinks (permission indicator + conditional OOUI edit controls) and BeforePageDisplay (conditional RL module loading + config vars). ApiFilePermSetLevel.php implements a CSRF-protected API module that validates, stores via PermissionService, and logs via ManualLogEntry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register hooks, API, rights, log type, and RL modules in extension.json + i18n</name>
  <files>
    extension.json
    i18n/en.json
  </files>
  <action>
**Update extension.json** -- add to the EXISTING file (do not overwrite existing registrations):

1. Add `"display"` HookHandler:
```json
"display": {
    "class": "FilePermissions\\Hooks\\DisplayHooks",
    "services": [ "FilePermissions.PermissionService" ]
}
```

2. Add hooks to the Hooks section:
```json
"ImagePageAfterImageLinks": "display",
"BeforePageDisplay": "display"
```

3. Add API module:
```json
"APIModules": {
    "fileperm-set-level": {
        "class": "FilePermissions\\Api\\ApiFilePermSetLevel",
        "services": [ "FilePermissions.PermissionService" ]
    }
}
```

4. Add user right:
```json
"AvailableRights": [ "edit-fileperm" ],
"GroupPermissions": {
    "sysop": {
        "edit-fileperm": true
    }
}
```

5. Add log type:
```json
"LogTypes": [ "fileperm" ],
"LogNames": {
    "fileperm": "filepermissions-log-name"
},
"LogHeaders": {
    "fileperm": "filepermissions-log-header"
},
"LogActionsHandlers": {
    "fileperm/*": "LogFormatter"
}
```

6. Add ResourceLoader modules:
```json
"ResourceModules": {
    "ext.FilePermissions.indicator": {
        "localBasePath": "modules",
        "remoteExtPath": "FilePermissions/modules",
        "styles": [
            "ext.FilePermissions.edit.css"
        ]
    },
    "ext.FilePermissions.edit": {
        "localBasePath": "modules",
        "remoteExtPath": "FilePermissions/modules",
        "packageFiles": [
            "ext.FilePermissions.edit.js"
        ],
        "dependencies": [
            "mediawiki.api",
            "mediawiki.notify",
            "oojs-ui-core"
        ],
        "messages": [
            "filepermissions-edit-success",
            "filepermissions-edit-error"
        ]
    }
}
```

**Update i18n/en.json** -- add all new messages to the EXISTING file:

```json
"filepermissions-level-label": "Permission level:",
"filepermissions-edit-save": "Save",
"filepermissions-edit-success": "Permission level updated.",
"filepermissions-edit-error": "Failed to update permission level.",
"filepermissions-log-name": "File permission log",
"filepermissions-log-header": "This log tracks changes to file permission levels.",
"logentry-fileperm-change": "$1 {{GENDER:$2|changed}} the permission level of $3 from $4 to $5",
"filepermissions-api-nosuchpage": "The specified file page does not exist.",
"right-edit-fileperm": "Change file permission levels"
```

IMPORTANT: Preserve all existing content in both files. Add new entries alongside existing ones. Maintain valid JSON formatting.
  </action>
  <verify>
Run `python3 -m json.tool extension.json > /dev/null && python3 -m json.tool i18n/en.json > /dev/null` -- both files must be valid JSON. Verify that existing entries (HookHandlers.enforcement, HookHandlers.upload, Hooks.getUserPermissionsErrors, etc.) are still present.
  </verify>
  <done>
extension.json registers the display HookHandler, both hooks, API module, edit-fileperm right assigned to sysop, fileperm log type, and two RL modules (indicator styles + edit JS). i18n/en.json contains all new messages for the indicator label, edit save button, success/error notifications, log entries, API errors, and the right description.
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/Hooks/DisplayHooks.php` passes (no syntax errors)
2. `php -l includes/Api/ApiFilePermSetLevel.php` passes (no syntax errors)
3. `python3 -m json.tool extension.json > /dev/null` passes (valid JSON)
4. `python3 -m json.tool i18n/en.json > /dev/null` passes (valid JSON)
5. extension.json contains: HookHandlers.display, Hooks.ImagePageAfterImageLinks, Hooks.BeforePageDisplay, APIModules.fileperm-set-level, AvailableRights, GroupPermissions.sysop.edit-fileperm, LogTypes, ResourceModules
6. All existing extension.json entries (enforcement, upload hooks, config) are preserved
</verification>

<success_criteria>
- DisplayHooks.php renders permission indicator via ImagePageAfterImageLinks and conditionally loads edit module via BeforePageDisplay
- ApiFilePermSetLevel.php handles CSRF-protected permission saves with validation and audit logging
- extension.json registers all new components alongside existing ones
- i18n/en.json contains all display, edit, log, and API error messages
- All files pass syntax/JSON validation
</success_criteria>

<output>
After completion, create `.planning/phases/04-display-management/04-01-SUMMARY.md`
</output>
