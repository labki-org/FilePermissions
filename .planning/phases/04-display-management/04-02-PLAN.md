---
phase: 04-display-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - modules/ext.FilePermissions.edit.js
  - modules/ext.FilePermissions.edit.css
autonomous: false

must_haves:
  truths:
    - "Permission level badge is visually styled on File: description pages"
    - "Save button triggers AJAX call to fileperm-set-level API with CSRF token"
    - "Success notification appears after saving, badge text updates without page reload"
    - "Error notification appears if save fails"
    - "Save button disables during save to prevent double-submit"
  artifacts:
    - path: "modules/ext.FilePermissions.edit.js"
      provides: "Client-side save logic for permission edit"
      contains: "fileperm-set-level"
    - path: "modules/ext.FilePermissions.edit.css"
      provides: "Styles for indicator badge and edit controls"
      contains: "fileperm-indicator"
  key_links:
    - from: "modules/ext.FilePermissions.edit.js"
      to: "includes/Api/ApiFilePermSetLevel.php"
      via: "mw.Api().postWithToken('csrf', {action: 'fileperm-set-level'})"
      pattern: "fileperm-set-level"
    - from: "modules/ext.FilePermissions.edit.js"
      to: "mw.config"
      via: "mw.config.get('wgFilePermCurrentLevel')"
      pattern: "wgFilePermCurrentLevel"
---

<objective>
Create the frontend JavaScript and CSS for the file permission edit interface on File: description pages.

Purpose: This plan creates the client-side behavior that makes the sysop edit control functional -- handling the save button click, calling the API with CSRF protection, updating the UI badge, and providing success/error feedback. Also styles the permission indicator and edit controls.

Output: ext.FilePermissions.edit.js (AJAX save logic), ext.FilePermissions.edit.css (indicator + edit control styles). Plus human verification of the complete feature.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-display-management/04-RESEARCH.md
@.planning/phases/04-display-management/04-01-SUMMARY.md

@includes/Hooks/DisplayHooks.php
@includes/Api/ApiFilePermSetLevel.php
@extension.json
@i18n/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JavaScript save module and CSS styles</name>
  <files>
    modules/ext.FilePermissions.edit.js
    modules/ext.FilePermissions.edit.css
  </files>
  <action>
Create the `modules/` directory if it does not exist.

**ext.FilePermissions.edit.js** (`modules/ext.FilePermissions.edit.js`):
- IIFE pattern: `( function () { 'use strict'; ... }() );`
- Read config vars set by DisplayHooks BeforePageDisplay:
  - `var currentLevel = mw.config.get( 'wgFilePermCurrentLevel' );`
  - `var pageTitle = mw.config.get( 'wgFilePermPageTitle' );`
- Find the save button: `var $saveBtn = $( '#fileperm-edit-save' );`
- Guard: if `!$saveBtn.length`, return (edit controls not rendered, user lacks permission)
- Bind click handler on `$saveBtn`:
  - Read new level from OOUI DropdownInputWidget: `$( '#fileperm-edit-dropdown select, #fileperm-edit-dropdown input' ).val()`
    - OOUI DropdownInputWidget may render as `<select>` or `<input>` depending on config. Query both selectors.
  - If `!newLevel || newLevel === currentLevel`, return (no change)
  - Disable save button: `$saveBtn.prop( 'disabled', true )`
  - Create API instance: `var api = new mw.Api();`
  - Call: `api.postWithToken( 'csrf', { action: 'fileperm-set-level', title: pageTitle, level: newLevel } )`
  - On success (`.then` first callback):
    - `mw.notify( mw.msg( 'filepermissions-edit-success' ), { type: 'success' } )`
    - Update badge text: `$( '#fileperm-level-badge' ).text( newLevel )`
    - Update tracked state: `currentLevel = newLevel`
    - Re-enable save button
  - On failure (`.then` second callback):
    - `mw.notify( mw.msg( 'filepermissions-edit-error' ), { type: 'error' } )`
    - Re-enable save button

IMPORTANT: Follow the IIFE pattern used in the existing codebase. Use `mw.Api().postWithToken('csrf', ...)` NOT manual token handling. Use `mw.notify` for feedback. Use `mw.msg` for i18n message retrieval.

**ext.FilePermissions.edit.css** (`modules/ext.FilePermissions.edit.css`):
- `.fileperm-section`: margin-top 1em, padding 0.5em 0, border-top 1px solid #a7d7f9 (MW info panel blue)
- `.fileperm-indicator`: margin-bottom 0.5em
- `.fileperm-level-badge`: display inline-block, padding 2px 8px, background-color #eaf3fb (light blue), border 1px solid #a7d7f9, border-radius 3px, font-weight bold
- `.fileperm-edit-controls`: display flex, align-items center, gap 0.5em
- Keep styles minimal and consistent with MediaWiki's visual language. No fancy colors or animations.
  </action>
  <verify>
Run `test -f modules/ext.FilePermissions.edit.js && test -f modules/ext.FilePermissions.edit.css && echo "FILES_EXIST"` -- both files must exist. Check JS syntax with `node --check modules/ext.FilePermissions.edit.js` if node is available, otherwise verify IIFE structure manually.
  </verify>
  <done>
ext.FilePermissions.edit.js handles save button clicks via mw.Api().postWithToken('csrf', ...) to the fileperm-set-level API, updates the badge text on success, shows mw.notify feedback for success/error, and disables the button during save. ext.FilePermissions.edit.css provides clean styling for the indicator badge and edit controls consistent with MW visual language.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete file permission display and management feature on File: description pages:
- Permission level indicator visible to authorized users
- OOUI dropdown + save button visible to sysop users only
- AJAX save with CSRF protection, audit logging to Special:Log/fileperm
- Success/error notifications via mw.notify
- Badge updates without page reload
  </what-built>
  <how-to-verify>
1. Navigate to a File: page for a file that has a permission level set (from a prior upload)
2. Verify the permission level indicator appears below the "pages that use this file" section
3. Verify the indicator shows "Permission level:" followed by the level name in a styled badge
4. If logged in as sysop:
   a. Verify a dropdown and "Save" button appear below the indicator
   b. Change the dropdown to a different level and click "Save"
   c. Verify a green success notification appears
   d. Verify the badge text updates to the new level without page reload
   e. Refresh the page -- verify the new level persists
   f. Navigate to Special:Log/fileperm -- verify the change is logged with old and new level
5. If logged in as non-sysop (but authorized to view the file):
   a. Verify the indicator is visible
   b. Verify NO dropdown or save button is shown
6. Check a File: page for a file WITHOUT a permission level -- verify no indicator appears
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `modules/ext.FilePermissions.edit.js` exists and contains IIFE with mw.Api().postWithToken call
2. `modules/ext.FilePermissions.edit.css` exists and styles .fileperm-section, .fileperm-indicator, .fileperm-level-badge, .fileperm-edit-controls
3. Permission indicator appears on File pages for files with a level
4. Edit controls appear only for sysop users
5. Save changes the level in PageProps and logs to Special:Log/fileperm
6. Badge updates on save without page reload
</verification>

<success_criteria>
- JavaScript save module correctly calls the API with CSRF token and updates UI on success/failure
- CSS provides clean, MW-consistent styling for the indicator and edit controls
- Human verification confirms the full feature works end-to-end: display, edit, persist, log
- Non-sysop users see indicator only, no edit controls
- Files without permission levels show no indicator
</success_criteria>

<output>
After completion, create `.planning/phases/04-display-management/04-02-SUMMARY.md`
</output>
