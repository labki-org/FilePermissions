---
phase: 10-ci-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "GitHub Actions workflow triggers on PRs to main and pushes to main"
    - "Docker Compose environment starts with health checks confirming wiki readiness"
    - "PHPUnit unit and integration tests run inside the Docker container and report pass/fail"
    - "E2E HTTP leak check tests run against the live wiki and report pass/fail"
    - "Both test jobs must pass for PR mergeability (required status checks)"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline workflow running all test tiers"
      min_lines: 80
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "docker-compose.yml"
      via: "docker compose up"
      pattern: "docker compose up"
    - from: ".github/workflows/ci.yml"
      to: "tests/phpunit/unit/"
      via: "phpunit execution inside container"
      pattern: "phpunit|vendor/bin/phpunit"
    - from: ".github/workflows/ci.yml"
      to: "tests/phpunit/e2e/"
      via: "standalone phpunit execution for E2E tests"
      pattern: "phpunit.*e2e|E2E"
---

<objective>
Create the GitHub Actions CI workflow that runs all three test tiers (unit, integration, E2E) automatically on every PR and push to main.

Purpose: This is the final phase of v1.1 -- it closes the loop by ensuring all the tests built in phases 7-9 run automatically, preventing regressions from ever reaching main.

Output: `.github/workflows/ci.yml` -- a single workflow file that starts the Docker environment, runs tests, and gates PR mergeability.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ci-pipeline/10-CONTEXT.md

# Existing infrastructure
@docker-compose.yml
@tests/LocalSettings.test.php
@tests/apache-filepermissions.conf
@tests/scripts/reinstall_test_env.sh
@tests/phpunit/e2e/E2ETestBase.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with the following structure:

**Triggers:**
- `pull_request` targeting `main`
- `push` to `main`

**Concurrency:**
- Group by `${{ github.workflow }}-${{ github.ref }}` so new pushes to same PR cancel in-progress runs
- `cancel-in-progress: true`

**Overall timeout:** 15 minutes per job

**Job structure:** Two sequential jobs because E2E tests need the same Docker environment as unit/integration tests, but unit/integration run INSIDE the container while E2E runs OUTSIDE against it. Use a single job with sequential steps (NOT parallel jobs) to avoid spinning up Docker twice.

**Single job: `test`**

Steps:

1. **Checkout** - `actions/checkout@v4`

2. **Start Docker environment** - `docker compose up -d`

3. **Wait for wiki readiness (health check)** - Use a polling loop that checks the MW API endpoint instead of `sleep 30`. Poll `http://localhost:8888/api.php?action=query&meta=siteinfo&format=json` every 5 seconds with a 120-second timeout. Use curl with `-sf` flags (silent, fail on HTTP errors). Example:
   ```
   timeout 120 bash -c 'until curl -sf http://localhost:8888/api.php?action=query\&meta=siteinfo\&format=json > /dev/null 2>&1; do echo "Waiting for wiki..."; sleep 5; done'
   ```
   This satisfies CI-02 (health checks, not fixed sleep).

4. **Create test user** - `docker compose exec -T wiki php maintenance/run.php createAndPromote TestUser testpass123` (same as reinstall_test_env.sh). Add `|| true` since user may already exist on cached runs.

5. **Run update.php** - `docker compose exec -T wiki php maintenance/run.php update --quick` to ensure the extension's database tables (fileperm_levels) are created. The extension registers its schema via extension.json but it only gets applied when update.php runs.

6. **Run unit + integration tests (CI-03)** - Execute PHPUnit inside the Docker container:
   ```
   docker compose exec -T wiki php vendor/bin/phpunit --testdox extensions/FilePermissions/tests/phpunit/unit/ extensions/FilePermissions/tests/phpunit/integration/
   ```
   Note: Inside the container, the extension is mounted at `/var/www/html/extensions/FilePermissions` (the labki-platform `mw-user-extensions` mount maps to `/var/www/html/extensions/`). The path should be relative to the MW install root. Check: labki-platform mounts `mw-user-extensions` to extensions directory, so the path is `extensions/FilePermissions/tests/phpunit/unit/` etc.

   Actually, based on the docker-compose.yml volume mount `./:/mw-user-extensions/FilePermissions`, the extension is at `/mw-user-extensions/FilePermissions` but labki-platform likely symlinks or copies user extensions into `/var/www/html/extensions/`. The MW test runner needs tests to be discoverable from the MW install root.

   Use this approach: Run from inside the container at the MW root:
   ```
   docker compose exec -T -w /var/www/html wiki php tests/phpunit/phpunit.php --testdox extensions/FilePermissions/tests/phpunit/unit/ extensions/FilePermissions/tests/phpunit/integration/
   ```

   If MW core uses `vendor/bin/phpunit` instead of `tests/phpunit/phpunit.php`, use that. The key is running MW's PHPUnit runner (not standalone PHPUnit) because unit tests extend MediaWikiUnitTestCase and integration tests extend MediaWikiIntegrationTestCase.

   Try `vendor/bin/phpunit` first (more common in MW 1.44). If the container doesn't have it, fall back to `php tests/phpunit/phpunit.php`.

   Use `--testdox` for readable output in CI logs.

7. **Run E2E tests (CI-04)** - E2E tests extend `PHPUnit\Framework\TestCase` (NOT MediaWiki test classes) and run as external HTTP clients. They need PHP + curl + PHPUnit available. Two approaches:

   **Approach A (preferred -- run inside container):** The container already has PHP and curl. Install PHPUnit standalone or use the MW-bundled one. Run:
   ```
   docker compose exec -T wiki php vendor/bin/phpunit --testdox extensions/FilePermissions/tests/phpunit/e2e/
   ```
   But E2E tests connect to `localhost:8888` which from inside the container should be `localhost:80`. The E2ETestBase hardcodes `WIKI_URL = 'http://localhost:8888'`. So running inside the container won't work without modifying the URL.

   **Approach B (run on the runner):** Install PHP + curl on the ubuntu-latest runner (they're pre-installed). Install PHPUnit via composer or download the phar. E2E tests connect to `localhost:8888` which works from the runner because Docker maps port 8888.

   **Use Approach B:** Install PHPUnit on the runner and run E2E tests directly:
   ```
   # Download PHPUnit phar (version 10.x for PHP 8.x compatibility)
   curl -L -o phpunit.phar https://phar.phpunit.de/phpunit-10.phar
   chmod +x phpunit.phar

   # Run E2E tests from the repo root
   php phpunit.phar --testdox --bootstrap vendor/autoload.php tests/phpunit/e2e/
   ```

   Wait -- the extension doesn't have a `vendor/` directory or composer autoloading. E2E test classes use `namespace FilePermissions\Tests\E2E` and `use PHPUnit\Framework\TestCase`. PHPUnit phar includes its own TestCase. The tests just need to be loaded.

   Simpler approach: E2E tests only import `PHPUnit\Framework\TestCase` which is bundled with the PHPUnit phar. Just run:
   ```
   php phpunit.phar --testdox tests/phpunit/e2e/
   ```
   PHPUnit will autoload its own classes. The test files use `namespace FilePermissions\Tests\E2E` but PHPUnit discovers test classes from files, not from autoloading. This should work.

8. **Print Docker logs on failure** - Add an `if: failure()` step that runs `docker compose logs wiki` to help debug CI failures.

**GitHub Actions summary annotation:**
Add a step that writes a summary to `$GITHUB_STEP_SUMMARY` showing test results status. Keep it simple: "Unit/Integration: PASS" and "E2E: PASS" or the relevant failure message.

**Important workflow YAML details:**
- Use `name: CI` as the workflow name
- Job name should be descriptive: `test` with display name "Unit, Integration & E2E Tests"
- Use `runs-on: ubuntu-latest`
- Set `timeout-minutes: 15`

**CI-05 (merge gate):** This is configured in GitHub repository settings, not in the workflow file. Add a YAML comment noting that the `test` job must be configured as a required status check in the repo's branch protection rules. The plan summary should mention this as a manual step.
  </action>
  <verify>
Verify the workflow file is valid YAML:
```
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))" && echo "Valid YAML"
```

Verify all required elements are present:
- `on: pull_request` and `on: push` triggers targeting main
- `concurrency` group with cancel-in-progress
- `timeout-minutes: 15`
- Docker compose up step
- Health check polling loop (no `sleep` as the sole wait mechanism)
- `createAndPromote` step for test user
- `update.php` step for DB schema
- PHPUnit execution step for unit + integration tests
- PHPUnit execution step for E2E tests
- `if: failure()` step for Docker logs
  </verify>
  <done>
`.github/workflows/ci.yml` exists with: PR + push triggers to main, concurrency groups, Docker health check polling, unit/integration tests inside container, E2E tests against live wiki, failure diagnostics step, and timeout of 15 minutes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify workflow structure and add CI-05 documentation</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Review the created workflow and verify:

1. The workflow YAML is syntactically valid
2. All 5 CI requirements are addressed:
   - CI-01: Triggers on PRs to main and pushes to main
   - CI-02: Health check polling loop (not sleep)
   - CI-03: Unit + integration tests run inside Docker container
   - CI-04: E2E tests run against live wiki
   - CI-05: Comment in workflow noting required status check configuration

3. Add a comment block at the top of the workflow file:
   ```yaml
   # FilePermissions CI Pipeline
   #
   # Runs all test tiers on PRs to main and pushes to main:
   #   1. Unit + Integration tests (inside Docker container via MW PHPUnit)
   #   2. E2E HTTP leak checks (against live wiki from runner)
   #
   # MERGE GATE (CI-05): Configure "test" as a required status check
   # in GitHub repo Settings > Branches > Branch protection rules > main
   ```

4. Ensure the E2E step properly handles the case where PHPUnit is not installed on the runner by downloading the phar first.

5. Ensure `docker compose` (v2 syntax, not `docker-compose`) is used consistently since GitHub Actions ubuntu-latest has Docker Compose v2.
  </action>
  <verify>
```
# Validate YAML syntax
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))" && echo "YAML OK"

# Check for required patterns
grep -q "pull_request" .github/workflows/ci.yml && echo "CI-01: PR trigger OK"
grep -q "push" .github/workflows/ci.yml && echo "CI-01: Push trigger OK"
grep -q "until curl" .github/workflows/ci.yml && echo "CI-02: Health check OK"
grep -q "phpunit" .github/workflows/ci.yml && echo "CI-03/04: PHPUnit OK"
grep -q "CI-05" .github/workflows/ci.yml && echo "CI-05: Merge gate documented"
grep -q "timeout-minutes" .github/workflows/ci.yml && echo "Timeout OK"
grep -q "concurrency" .github/workflows/ci.yml && echo "Concurrency OK"
```
  </verify>
  <done>
Workflow file passes YAML validation, contains all 5 CI requirement implementations (CI-01 through CI-04 in code, CI-05 as documented configuration), uses Docker Compose v2 syntax, and includes CI-05 merge gate documentation comment.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` exists and is valid YAML
2. Workflow triggers on `pull_request` to main and `push` to main
3. Concurrency group cancels in-progress runs on same PR
4. Docker environment starts with HTTP health check polling (not fixed `sleep`)
5. TestUser is created in the container
6. update.php runs to apply extension DB schema
7. Unit + integration tests execute inside the Docker container
8. E2E tests execute from the runner against localhost:8888
9. Docker logs are captured on failure
10. CI-05 merge gate is documented as a manual repo setting
</verification>

<success_criteria>
- `.github/workflows/ci.yml` is a valid GitHub Actions workflow
- All 5 CI requirements (CI-01 through CI-05) are addressed
- The workflow uses health check polling, not fixed sleep
- Unit/integration tests run inside the container (MW PHPUnit runner)
- E2E tests run from the runner against the Docker wiki
- Timeout is 15 minutes, concurrency cancels stale runs
- Failure step captures Docker logs for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/10-ci-pipeline/10-01-SUMMARY.md`
</output>
