---
phase: 02-core-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Hooks/EnforcementHooks.php
  - extension.json
  - i18n/en.json
autonomous: true

must_haves:
  truths:
    - "getUserPermissionsErrors hook blocks unauthorized File: page access"
    - "ImgAuthBeforeStream hook blocks unauthorized raw file/thumbnail access"
    - "ImageBeforeProduceHTML hook replaces embedded images with placeholder"
  artifacts:
    - path: "includes/Hooks/EnforcementHooks.php"
      provides: "All three enforcement hook implementations"
      exports: ["onGetUserPermissionsErrors", "onImgAuthBeforeStream", "onImageBeforeProduceHTML"]
    - path: "extension.json"
      provides: "Hook handler registration"
      contains: "enforcement"
    - path: "i18n/en.json"
      provides: "Error messages"
      contains: "filepermissions-access-denied"
  key_links:
    - from: "includes/Hooks/EnforcementHooks.php"
      to: "PermissionService"
      via: "constructor injection"
      pattern: "\\$this->permissionService->canUserAccessFile"
    - from: "extension.json"
      to: "EnforcementHooks"
      via: "HookHandlers registration"
      pattern: "FilePermissions\\\\Hooks\\\\EnforcementHooks"
---

<objective>
Create the enforcement hooks that deny unauthorized access to protected files through all content paths: File: description pages, raw file requests via img_auth.php, and embedded images.

Purpose: This is the core security layer - without these hooks, permissions are stored but not enforced.
Output: EnforcementHooks.php implementing three MediaWiki hooks, registered via extension.json HookHandlers.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-enforcement/02-CONTEXT.md
@.planning/phases/02-core-enforcement/02-RESEARCH.md
@includes/PermissionService.php
@extension.json
@i18n/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EnforcementHooks class</name>
  <files>includes/Hooks/EnforcementHooks.php</files>
  <action>
Create EnforcementHooks.php implementing three hook interfaces with PermissionService injection.

**Class structure:**
```php
namespace FilePermissions\Hooks;

use MediaWiki\Permissions\Hook\GetUserPermissionsErrorsHook;
use MediaWiki\Hook\ImgAuthBeforeStreamHook;
use MediaWiki\Hook\ImageBeforeProduceHTMLHook;
use MediaWiki\Context\RequestContext;
use FilePermissions\PermissionService;

class EnforcementHooks implements
    GetUserPermissionsErrorsHook,
    ImgAuthBeforeStreamHook,
    ImageBeforeProduceHTMLHook
```

**onGetUserPermissionsErrors** (ENFC-01):
- Check namespace === NS_FILE, action === 'read' - return true (allow) if not
- Call `$this->permissionService->canUserAccessFile($user, $title)`
- If denied: set `$result = ['filepermissions-access-denied']`, return false
- Generic error - does NOT reveal required permission level

**onImgAuthBeforeStream** (ENFC-02, ENFC-03):
- Get user via `RequestContext::getMain()->getUser()`
- Call `$this->permissionService->canUserAccessFile($user, $title)`
- If denied: set `$result = ['img-auth-accessdenied', 'filepermissions-img-denied']`, return false
- The $title is already resolved from thumbnail/archive paths by MediaWiki

**onImageBeforeProduceHTML** (ENFC-04):
- Get user via `RequestContext::getMain()->getUser()`
- Call `$this->permissionService->canUserAccessFile($user, $title)`
- If denied: generate placeholder HTML, set `$res`, return false
- Placeholder: inline SVG lock icon, sized to match requested dimensions
- NOT clickable - dead end to reduce discoverability
- Use fallback 220px if dimensions not specified

**generatePlaceholderHtml** private method:
- Lock icon SVG (grayscale, minimal)
- Inline as data URI to avoid extra HTTP request
- Style: inline-block, width/height from params, centered background, light gray fill
- Add border for visual definition

Refer to research document patterns 3, 4, 5 for exact implementation.
  </action>
  <verify>php -l includes/Hooks/EnforcementHooks.php returns no syntax errors</verify>
  <done>EnforcementHooks.php exists with all three hook methods and placeholder generator</done>
</task>

<task type="auto">
  <name>Task 2: Register hooks in extension.json</name>
  <files>extension.json</files>
  <action>
Add HookHandlers and Hooks sections to extension.json.

**Add HookHandlers block** (after ServiceWiringFiles):
```json
"HookHandlers": {
    "enforcement": {
        "class": "FilePermissions\\Hooks\\EnforcementHooks",
        "services": [
            "FilePermissions.PermissionService"
        ]
    }
}
```

**Add Hooks block** (after HookHandlers):
```json
"Hooks": {
    "getUserPermissionsErrors": "enforcement",
    "ImgAuthBeforeStream": "enforcement",
    "ImageBeforeProduceHTML": "enforcement"
}
```

These registrations tell MediaWiki to:
1. Instantiate EnforcementHooks with PermissionService injected
2. Call the appropriate method when each hook fires
  </action>
  <verify>cat extension.json | python3 -m json.tool validates JSON syntax</verify>
  <done>extension.json has HookHandlers.enforcement and Hooks entries for all three hooks</done>
</task>

<task type="auto">
  <name>Task 3: Add i18n error messages</name>
  <files>i18n/en.json</files>
  <action>
Add error messages for access denials.

**Add these messages:**
```json
"filepermissions-access-denied": "You do not have permission to view this file.",
"filepermissions-img-denied": "You do not have permission to access this file."
```

Messages are generic - they do NOT reveal:
- What permission level is required
- That a permission system exists (looks like standard MW error)
- How to request access

Keep the same tone as existing MediaWiki permission errors.
  </action>
  <verify>cat i18n/en.json | python3 -m json.tool validates JSON syntax</verify>
  <done>i18n/en.json contains filepermissions-access-denied and filepermissions-img-denied messages</done>
</task>

</tasks>

<verification>
All tasks complete when:
1. `php -l includes/Hooks/EnforcementHooks.php` - no syntax errors
2. `cat extension.json | python3 -m json.tool` - valid JSON
3. `cat i18n/en.json | python3 -m json.tool` - valid JSON
4. `grep -q "EnforcementHooks" extension.json` - hooks registered
5. `grep -q "filepermissions-access-denied" i18n/en.json` - messages present
</verification>

<success_criteria>
- EnforcementHooks.php implements GetUserPermissionsErrorsHook, ImgAuthBeforeStreamHook, ImageBeforeProduceHTMLHook
- Constructor accepts PermissionService via dependency injection
- All three onXxx methods call permissionService->canUserAccessFile()
- Placeholder HTML is inline SVG, not clickable
- Hooks registered in extension.json HookHandlers
- Error messages in i18n/en.json
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-enforcement/02-01-SUMMARY.md`
</output>
