---
phase: 02-core-enforcement
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Unauthorized user receives permission error on File: page"
    - "Unauthorized user receives 403 on raw file request via img_auth.php"
    - "Unauthorized user sees placeholder instead of embedded image"
    - "Authorized user sees everything normally"
  artifacts: []
  key_links: []
---

<objective>
Verify that all enforcement hooks work correctly in a real MediaWiki environment.

Purpose: Code is written, but enforcement must be tested against a live wiki to confirm access is actually denied.
Output: Human verification that all four access paths are properly blocked for unauthorized users.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-enforcement/02-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete enforcement layer with three hooks:
1. getUserPermissionsErrors - blocks File: description page access
2. ImgAuthBeforeStream - blocks raw file and thumbnail requests
3. ImageBeforeProduceHTML - replaces embedded images with placeholder
  </what-built>
  <how-to-verify>
**Prerequisites:**
- MediaWiki test instance running with FilePermissions enabled
- img_auth.php configured ($wgUploadPath pointing to img_auth.php)
- At least one test file uploaded with a permission level set
- Test user account NOT in a group that has access to that level

**Test 1: File: description page (ENFC-01)**
1. Log in as test user (unauthorized)
2. Navigate to File:TestProtectedFile.png
3. Expected: Permission error page with "You do not have permission to view this file."
4. Log in as sysop/authorized user
5. Navigate to same page
6. Expected: Normal file description page renders

**Test 2: Raw file via img_auth.php (ENFC-02)**
1. Log in as test user (unauthorized)
2. Navigate to /img_auth.php/X/Xx/TestProtectedFile.png (actual path varies)
3. Expected: 403 response with "Access Denied"
4. Log in as sysop/authorized user
5. Navigate to same URL
6. Expected: File downloads/displays normally

**Test 3: Thumbnail via img_auth.php (ENFC-03)**
1. Log in as test user (unauthorized)
2. Navigate to /img_auth.php/thumb/X/Xx/TestProtectedFile.png/220px-TestProtectedFile.png
3. Expected: 403 response (thumbnail inherits parent permission)
4. Log in as sysop/authorized user
5. Expected: Thumbnail renders normally

**Test 4: Embedded image (ENFC-04)**
1. Create a test page with [[File:TestProtectedFile.png|thumb|Test caption]]
2. Log in as test user (unauthorized)
3. View the test page
4. Expected: Gray placeholder box with lock icon, NOT clickable, same size as would-be thumbnail
5. Log in as sysop/authorized user
6. View same page
7. Expected: Normal embedded image with caption

**If any test fails:** Describe what happened vs. what was expected.
  </how-to-verify>
  <resume-signal>Type "verified" if all 4 tests pass, or describe which tests failed and how</resume-signal>
</task>

</tasks>

<verification>
Human confirms all access paths are blocked for unauthorized users.
</verification>

<success_criteria>
- All 4 test scenarios pass as described
- Authorized users can access everything
- Unauthorized users are blocked at every path
- Error messages are generic (no information leakage)
- Placeholder is visible but unobtrusive
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-enforcement/02-02-SUMMARY.md`
</output>
