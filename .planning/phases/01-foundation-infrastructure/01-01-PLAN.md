---
phase: 01-foundation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - extension.json
  - includes/Config.php
  - includes/Hooks/RegistrationHooks.php
  - i18n/en.json
autonomous: true

must_haves:
  truths:
    - "Permission levels configurable via $wgFilePermLevels array"
    - "Group grants configurable via $wgFilePermGroupGrants"
    - "Extension validates configuration on load"
    - "Invalid configuration triggers fail-closed behavior"
  artifacts:
    - path: "extension.json"
      provides: "Extension manifest with config variables and callback"
      contains: "FilePermissions"
    - path: "includes/Config.php"
      provides: "Static typed config access"
      exports: ["getLevels", "getGroupGrants", "getDefaultLevel", "getNamespaceDefaults", "isInvalidConfig", "isValidLevel"]
    - path: "includes/Hooks/RegistrationHooks.php"
      provides: "Configuration validation on registration"
      exports: ["onRegistration"]
  key_links:
    - from: "extension.json"
      to: "includes/Hooks/RegistrationHooks.php"
      via: "callback registration"
      pattern: '"callback".*RegistrationHooks::onRegistration'
    - from: "includes/Hooks/RegistrationHooks.php"
      to: "includes/Config.php"
      via: "validation uses config getters"
      pattern: "Config::"
---

<objective>
Create the extension skeleton and configuration system for FilePermissions.

Purpose: Establish the foundation that all other phases depend on - the extension manifest, configuration variables, and validation that ensures fail-closed behavior on invalid config.

Output: Working extension that loads in MediaWiki with all configuration variables available and validated.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extension.json manifest</name>
  <files>extension.json, i18n/en.json</files>
  <action>
Create extension.json with manifest_version 2 containing:

1. Basic metadata:
   - name: "FilePermissions"
   - version: "1.0.0"
   - license-name: "GPL-2.0-or-later"
   - requires MediaWiki >= 1.44.0

2. Autoloading:
   - AutoloadNamespaces: "FilePermissions\\": "includes/"

3. Registration callback:
   - callback: "FilePermissions\\Hooks\\RegistrationHooks::onRegistration"

4. ServiceWiringFiles (empty array for now, Plan 02 will use):
   - ServiceWiringFiles: ["includes/ServiceWiring.php"]

5. Configuration variables with defaults:
   - FilePermLevels: ["public", "internal", "confidential"]
   - FilePermGroupGrants: {"sysop": ["*"], "user": ["public", "internal"]}
   - FilePermDefaultLevel: null (force explicit selection)
   - FilePermNamespaceDefaults: {} (empty object)
   - FilePermInvalidConfig: false (internal flag set by validation)

Also create i18n/en.json with:
- "@metadata": {"authors": ["FilePermissions Contributors"]}
- "filepermissions-desc": "Group-based file permission system"
  </action>
  <verify>
JSON is valid: `php -r "json_decode(file_get_contents('extension.json'), true) ?? exit(1);"`
i18n JSON is valid: `php -r "json_decode(file_get_contents('i18n/en.json'), true) ?? exit(1);"`
  </verify>
  <done>extension.json exists with all config variables defined, i18n/en.json exists with extension description</done>
</task>

<task type="auto">
  <name>Task 2: Create Config.php static class</name>
  <files>includes/Config.php</files>
  <action>
Create static Config class in FilePermissions namespace:

```php
namespace FilePermissions;

class Config {
    public static function getLevels(): array
    public static function getGroupGrants(): array
    public static function getDefaultLevel(): ?string
    public static function getNamespaceDefaults(): array
    public static function isInvalidConfig(): bool
    public static function isValidLevel(string $level): bool
    public static function resolveDefaultLevel(int $namespace): ?string
}
```

Implementation details:
- Each getter reads from $GLOBALS with fallback defaults
- getLevels() returns $wgFilePermLevels ?? ['public']
- getGroupGrants() returns $wgFilePermGroupGrants ?? []
- getDefaultLevel() returns $wgFilePermDefaultLevel ?? null
- getNamespaceDefaults() returns $wgFilePermNamespaceDefaults ?? []
- isInvalidConfig() returns $wgFilePermInvalidConfig ?? false
- isValidLevel() checks if level is in getLevels() array
- resolveDefaultLevel() checks namespace defaults first, then global default

Use strict_types=1 declaration. Follow MediaWiki coding standards (tabs for indentation).
  </action>
  <verify>
PHP syntax valid: `php -l includes/Config.php`
Class can be loaded: `php -r "require 'includes/Config.php'; echo 'OK';"`
  </verify>
  <done>Config.php exists with all typed accessors and resolveDefaultLevel method</done>
</task>

<task type="auto">
  <name>Task 3: Create RegistrationHooks.php with validation</name>
  <files>includes/Hooks/RegistrationHooks.php</files>
  <action>
Create RegistrationHooks class in FilePermissions\Hooks namespace:

```php
namespace FilePermissions\Hooks;

use MediaWiki\Logger\LoggerFactory;

class RegistrationHooks {
    public static function onRegistration(): void
    private static function validateConfiguration(): array
}
```

onRegistration() implementation:
1. Call validateConfiguration() to get array of error messages
2. If errors exist:
   - Set $GLOBALS['wgFilePermInvalidConfig'] = true
   - Log each error via LoggerFactory::getInstance('FilePermissions')->warning()

validateConfiguration() checks:
1. $wgFilePermLevels must be non-empty array of non-empty strings
2. $wgFilePermGroupGrants values must be arrays
3. Each grant level (except '*') must exist in $wgFilePermLevels
4. $wgFilePermDefaultLevel if set must be a valid level
5. $wgFilePermNamespaceDefaults values must be valid levels

On ANY validation failure:
- Return array of human-readable error messages
- Extension sets InvalidConfig flag but wiki continues to load
- All permission checks will deny when InvalidConfig is true (fail-closed)

Log format: 'FilePermissions: Invalid configuration - {error}'
  </action>
  <verify>
PHP syntax valid: `php -l includes/Hooks/RegistrationHooks.php`
  </verify>
  <done>RegistrationHooks.php exists with onRegistration callback and comprehensive validation</done>
</task>

</tasks>

<verification>
1. All PHP files pass syntax check: `find includes -name "*.php" -exec php -l {} \;`
2. extension.json is valid JSON
3. i18n/en.json is valid JSON
4. Directory structure matches AutoloadNamespaces pattern
</verification>

<success_criteria>
- extension.json defines all 5 configuration variables with sensible defaults
- Config.php provides typed access to all configuration with proper fallbacks
- RegistrationHooks validates configuration and sets fail-closed flag on error
- All files follow MediaWiki coding standards (tabs, strict_types)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md`
</output>
