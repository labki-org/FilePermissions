---
phase: 09-e2e-http-leak-checks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/phpunit/e2e/E2ETestBase.php
  - tests/phpunit/e2e/DirectPathAccessTest.php
autonomous: true

must_haves:
  truths:
    - "E2E base class authenticates test users via MW API login (cookie-based sessions)"
    - "E2E base class seeds test files at each permission level (public, internal, confidential) with correct fileperm_levels entries"
    - "E2E base class provides HTTP client helpers for authenticated and anonymous requests"
    - "Direct /images/ path returns 403 for all users (Apache denial, not MW)"
    - "Direct /images/thumb/ path returns 403 for all users (Apache denial, not MW)"
    - "E2E bootstrap verifies img_auth.php is active and private wiki mode is configured before running tests"
  artifacts:
    - path: "tests/phpunit/e2e/E2ETestBase.php"
      provides: "Base class with MW API auth, file seeding, HTTP client, bootstrap checks"
      min_lines: 150
    - path: "tests/phpunit/e2e/DirectPathAccessTest.php"
      provides: "Apache-level /images/ and /images/thumb/ denial tests"
      min_lines: 40
  key_links:
    - from: "tests/phpunit/e2e/E2ETestBase.php"
      to: "http://localhost:8888/api.php"
      via: "MW API login + cookie session management"
      pattern: "action=login|action=clientlogin"
    - from: "tests/phpunit/e2e/E2ETestBase.php"
      to: "fileperm_levels table"
      via: "MW API upload + fileperm-set-level API call"
      pattern: "fileperm-set-level|action=upload"
    - from: "tests/phpunit/e2e/DirectPathAccessTest.php"
      to: "Apache config"
      via: "Direct HTTP GET to /images/ paths"
      pattern: "assertSame.*403"
---

<objective>
Create E2E test infrastructure (base class with MW API authentication, file seeding at each permission level, HTTP helpers) and Apache direct-path denial tests.

Purpose: Provides the foundation for all E2E HTTP leak checks -- cookie-based sessions, test file seeding, and HTTP client wrappers. Also covers LEAK-03 and LEAK-04 (Apache-layer denial) which are independent of MediaWiki logic.

Output: E2ETestBase.php base class and DirectPathAccessTest.php test class
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/LocalSettings.test.php
@tests/apache-filepermissions.conf
@docker-compose.yml
@includes/Config.php
@includes/PermissionService.php
@includes/Api/ApiFilePermSetLevel.php
@includes/Hooks/EnforcementHooks.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2ETestBase with MW API auth, file seeding, and HTTP helpers</name>
  <files>tests/phpunit/e2e/E2ETestBase.php</files>
  <action>
Create `tests/phpunit/e2e/E2ETestBase.php` -- an abstract PHPUnit TestCase base class that all E2E tests extend. This class does NOT extend MediaWikiTestCase (E2E tests run as external HTTP clients, not inside MW runtime).

**HTTP client:** Use PHP's built-in `curl` functions (no external dependencies). Create helper methods:
- `httpGet(string $url, array $cookies = []): array` -- returns `['status' => int, 'body' => string, 'headers' => array]`
- `httpPost(string $url, array $data, array $cookies = []): array` -- same return format

**Constants:**
- `WIKI_URL = 'http://localhost:8888'` (from docker-compose.yml port mapping)
- `ADMIN_USER = 'Admin'`, `ADMIN_PASS = 'dockerpass'` (sysop, wildcard access)
- `TEST_USER = 'TestUser'`, `TEST_PASS = 'testpass123'` (user group, public+internal only)

**MW API authentication** (cookie-based sessions per LEAK-08):
- `loginUser(string $username, string $password): array` -- performs MW API `action=clientlogin` flow:
  1. GET `api.php?action=query&meta=tokens&type=login&format=json` to get login token (capture Set-Cookie headers)
  2. POST `api.php` with `action=clientlogin&username=X&password=Y&logintoken=T&loginreturnurl=http://localhost:8888&format=json` (send cookies from step 1)
  3. Return the full cookie array from both responses (session cookies)
  4. Throw if login fails (status !== 'PASS')
- Cache logged-in sessions per class (static property). Call `loginUser` in `setUpBeforeClass()` for admin and test user.

**Bootstrap verification** (in `setUpBeforeClass()`):
- Before any tests run, verify the wiki is reachable: GET `WIKI_URL/api.php?action=query&meta=siteinfo&format=json`, assert HTTP 200
- Verify img_auth.php is the active file path: check `$wgUploadPath` contains `img_auth.php` by querying `api.php?action=query&meta=siteinfo&siprop=general&format=json` and checking `uploadpath` field in response
- Verify private wiki mode: check that anonymous GET to a File: page redirects to login (or returns permission error)
- If any bootstrap check fails, mark all tests skipped with `self::markTestSkipped('E2E prerequisite not met: ...')`

**Test data seeding** (in `setUpBeforeClass()`, after login):
- Create TestUser if not exists: `docker compose exec -T wiki php maintenance/run.php createAndPromote TestUser testpass123` -- OR use MW API `action=createaccount` with admin session. Prefer the simpler approach: try login first, if it fails, skip tests with "TestUser not found -- run reinstall_test_env.sh".
- Upload 3 small test PNG files using admin session via MW API `action=upload`:
  - `E2E_Test_Public.png` (will be set to 'public' level)
  - `E2E_Test_Internal.png` (will be set to 'internal' level)
  - `E2E_Test_Confidential.png` (will be set to 'confidential' level)
  - Use a minimal 1x1 pixel PNG created inline as binary string (avoid external file dependencies):
    ```php
    $png = base64_decode('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==');
    ```
  - For each upload: POST multipart to `api.php` with `action=upload&filename=X&token=CSRF&ignorewarnings=1&format=json` and the file as `file` parameter
  - After upload, set permission level via `action=fileperm-set-level&title=File:X&level=Y&token=CSRF` (admin session)
  - Get CSRF token: `api.php?action=query&meta=tokens&format=json`
- Store uploaded file info (titles, levels) as static properties for test methods to reference.

**Cleanup** (in `tearDownAfterClass()`):
- Delete the 3 test files via MW API `action=delete&title=File:X&token=CSRF&reason=E2E+cleanup&format=json` using admin session
- Do NOT delete test users (they may be pre-seeded).

**Helper methods for subclasses:**
- `getAdminCookies(): array` -- returns cached admin session cookies
- `getTestUserCookies(): array` -- returns cached TestUser session cookies
- `getImgAuthUrl(string $filename): string` -- returns `WIKI_URL/img_auth.php/{filename}` (original file path)
- `getImgAuthThumbUrl(string $filename, string $thumbName): string` -- returns `WIKI_URL/img_auth.php/thumb/{filename}/{thumbName}` (thumbnail path)
- `getDirectImageUrl(string $filename): string` -- returns `WIKI_URL/images/{hash-path}/{filename}` (direct Apache path). Compute MD5 hash path: first 2 chars of md5(filename) as `a/ab/` format.
- `getDirectThumbUrl(string $filename, string $thumbName): string` -- returns `WIKI_URL/images/thumb/{hash-path}/{filename}/{thumbName}`
- `static getTestFileNames(): array` -- returns map of level => filename

**Important implementation notes:**
- Do NOT use Guzzle or any external HTTP library. PHP curl is sufficient and avoids dependency management.
- Cookie handling: accumulate Set-Cookie headers across requests for same session. Store as `['cookie_name' => 'value', ...]` array, send as `Cookie: name=value; name2=value2` header.
- Upload API requires multipart/form-data with CURLFile for the file parameter.
- Error handling: on any API error, provide clear assertion messages with the full API response for debugging.
  </action>
  <verify>
- File exists at `tests/phpunit/e2e/E2ETestBase.php`
- Class is abstract, extends `\PHPUnit\Framework\TestCase`
- Has `loginUser()`, `httpGet()`, `httpPost()`, `setUpBeforeClass()`, `tearDownAfterClass()` methods
- Has bootstrap checks for wiki reachability, img_auth.php, private wiki mode
- Has file seeding logic for 3 test files at 3 permission levels
- Has helper methods for URL construction (img_auth, direct, thumb variants)
- No external dependencies beyond PHP curl and PHPUnit
  </verify>
  <done>E2ETestBase provides cookie-based MW API auth, seeds 3 test files at all permission levels, includes bootstrap checks, and has URL helper methods for all access vectors. Subclasses can immediately make authenticated/anonymous HTTP requests against test files.</done>
</task>

<task type="auto">
  <name>Task 2: Create DirectPathAccessTest for Apache-layer denial</name>
  <files>tests/phpunit/e2e/DirectPathAccessTest.php</files>
  <action>
Create `tests/phpunit/e2e/DirectPathAccessTest.php` extending `E2ETestBase`.

This test class verifies LEAK-03 and LEAK-04: direct `/images/` and `/images/thumb/` paths return 403 for ALL users, regardless of authentication or permission level. This is Apache-layer denial (the `Require all denied` directive in apache-filepermissions.conf), not MediaWiki-level enforcement.

**Test methods (6 tests):**

1. `testDirectImagePath_Admin_Returns403()` -- Admin (sysop, has all grants) requests direct `/images/{hash}/{filename}` for any test file. Assert HTTP 403. This proves Apache blocks even fully-authorized users from bypassing img_auth.php.

2. `testDirectImagePath_TestUser_Returns403()` -- TestUser requests direct `/images/{hash}/{filename}`. Assert HTTP 403.

3. `testDirectImagePath_Anonymous_Returns403()` -- Anonymous (no cookies) requests direct `/images/{hash}/{filename}`. Assert HTTP 403.

4. `testDirectThumbPath_Admin_Returns403()` -- Admin requests direct `/images/thumb/{hash}/{filename}/{thumbName}`. Assert HTTP 403.

5. `testDirectThumbPath_TestUser_Returns403()` -- TestUser requests direct `/images/thumb/{hash}/{filename}/{thumbName}`. Assert HTTP 403.

6. `testDirectThumbPath_Anonymous_Returns403()` -- Anonymous requests direct `/images/thumb/{hash}/{filename}/{thumbName}`. Assert HTTP 403.

**Important distinction:**
- These tests verify the **Apache layer**, not the MediaWiki layer. The response body may be an Apache error page, not a MediaWiki error page.
- Use the `E2E_Test_Public.png` file (the one even regular users can access via img_auth.php) to prove that Apache blocks the direct path regardless of the file's permission level.
- For the thumbnail path, use a plausible thumb name format: `120px-E2E_Test_Public.png`

**Assertion approach:**
- Assert status code is 403 (Forbidden)
- Assertion message should note "Apache direct path block" to distinguish from MW-level 403 in CI output

**Class annotation:**
- Add `@group e2e` PHPUnit group annotation so E2E tests can be run separately from unit/integration tests
  </action>
  <verify>
- File exists at `tests/phpunit/e2e/DirectPathAccessTest.php`
- Extends E2ETestBase
- Has 6 test methods covering admin, TestUser, and anonymous for both /images/ and /images/thumb/
- All assertions check for HTTP 403
- Uses `@group e2e` annotation
  </verify>
  <done>DirectPathAccessTest verifies that direct /images/ and /images/thumb/ paths return HTTP 403 for all user types (admin, authenticated regular user, anonymous), proving Apache-layer denial is working independently of MediaWiki enforcement.</done>
</task>

</tasks>

<verification>
1. `tests/phpunit/e2e/E2ETestBase.php` exists with abstract class, MW API login, file seeding, bootstrap checks
2. `tests/phpunit/e2e/DirectPathAccessTest.php` exists with 6 test methods covering 3 user types x 2 path types
3. Both classes use `@group e2e` annotation
4. No external dependencies beyond PHP curl and PHPUnit
5. Bootstrap verifies wiki reachability, img_auth.php active, private wiki mode before any tests run
6. Test data lifecycle: seed in setUpBeforeClass, clean up in tearDownAfterClass
</verification>

<success_criteria>
- E2E base class provides complete test infrastructure: cookie auth, file seeding, HTTP helpers, bootstrap checks
- DirectPathAccessTest covers LEAK-03 (direct /images/) and LEAK-04 (direct /images/thumb/) for all 3 user roles
- Requirements satisfied: INFRA-03 (seeding), INFRA-04 (auth bootstrap), LEAK-03, LEAK-04, LEAK-08 (cookie sessions)
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-http-leak-checks/09-01-SUMMARY.md`
</output>
