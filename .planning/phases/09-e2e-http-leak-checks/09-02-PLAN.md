---
phase: 09-e2e-http-leak-checks
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - tests/phpunit/e2e/ImgAuthLeakTest.php
  - tests/phpunit/e2e/PermissionMatrixTest.php
autonomous: true

must_haves:
  truths:
    - "Unauthorized logged-in user gets 403 from img_auth.php for confidential file original download"
    - "Unauthorized logged-in user gets 403 from img_auth.php for confidential file thumbnail"
    - "Authorized user can download files at their granted permission levels via img_auth.php"
    - "Public files are accessible to all authenticated users via img_auth.php"
    - "Anonymous user gets denial (403 or redirect to login) from img_auth.php for any file"
    - "Full permission matrix tested: 3 levels x 3 user types x 2 access vectors = 18 scenarios"
  artifacts:
    - path: "tests/phpunit/e2e/ImgAuthLeakTest.php"
      provides: "Core img_auth.php denial tests for unauthorized and anonymous access"
      min_lines: 80
    - path: "tests/phpunit/e2e/PermissionMatrixTest.php"
      provides: "Complete permission matrix: 3 levels x 3 user types x 2 vectors with summary output"
      min_lines: 100
  key_links:
    - from: "tests/phpunit/e2e/ImgAuthLeakTest.php"
      to: "img_auth.php"
      via: "HTTP GET with cookies"
      pattern: "img_auth\\.php.*assertSame.*403"
    - from: "tests/phpunit/e2e/PermissionMatrixTest.php"
      to: "img_auth.php"
      via: "HTTP GET with user-specific cookies for all level/user/vector combos"
      pattern: "img_auth\\.php.*(200|403)"
    - from: "tests/phpunit/e2e/PermissionMatrixTest.php"
      to: "E2ETestBase"
      via: "Extends base class, uses seeded test files and auth helpers"
      pattern: "extends E2ETestBase"
---

<objective>
Implement img_auth.php leak check tests and the full permission matrix covering all levels, user roles, and access vectors.

Purpose: Proves the core security guarantee -- unauthorized users cannot download protected file bytes through img_auth.php, while authorized users retain access. The permission matrix provides complete coverage of the security surface.

Output: ImgAuthLeakTest.php (targeted denial tests) and PermissionMatrixTest.php (exhaustive matrix)
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-http-leak-checks/09-01-SUMMARY.md
@tests/LocalSettings.test.php
@includes/Hooks/EnforcementHooks.php
@includes/PermissionService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ImgAuthLeakTest for img_auth.php denial checks</name>
  <files>tests/phpunit/e2e/ImgAuthLeakTest.php</files>
  <action>
Create `tests/phpunit/e2e/ImgAuthLeakTest.php` extending `E2ETestBase`.

This test class verifies LEAK-01, LEAK-02, LEAK-05, and LEAK-06: img_auth.php correctly denies unauthorized access and allows authorized access for original files and thumbnails.

**Group annotation:** `@group e2e`

**Test methods for LEAK-01 (unauthorized original file download):**

1. `testUnauthorizedUser_ConfidentialFile_OriginalPath_Returns403()` -- TestUser (user group, no confidential grant) requests `img_auth.php/E2E_Test_Confidential.png`. Assert HTTP 403. TestUser has grants for public+internal, but NOT confidential.

2. `testUnauthorizedUser_ConfidentialFile_ThumbnailPath_Returns403()` -- TestUser requests `img_auth.php/thumb/E2E_Test_Confidential.png/120px-E2E_Test_Confidential.png`. Assert HTTP 403. (LEAK-02)

**Test methods for anonymous access denial:**

3. `testAnonymousUser_PublicFile_OriginalPath_DeniedOnPrivateWiki()` -- No cookies, request `img_auth.php/E2E_Test_Public.png`. On a private wiki, img_auth.php denies anonymous users entirely. Assert HTTP 403 (img_auth.php returns 403 for anonymous when `$wgGroupPermissions['*']['read'] = false`).

4. `testAnonymousUser_ConfidentialFile_OriginalPath_DeniedOnPrivateWiki()` -- No cookies, request `img_auth.php/E2E_Test_Confidential.png`. Assert HTTP 403.

**Test methods for LEAK-05 (authorized access works):**

5. `testAuthorizedUser_PublicFile_OriginalPath_Returns200()` -- TestUser requests `img_auth.php/E2E_Test_Public.png`. TestUser has 'public' grant. Assert HTTP 200 and response body is non-empty (contains actual file bytes).

6. `testAuthorizedUser_InternalFile_OriginalPath_Returns200()` -- TestUser requests `img_auth.php/E2E_Test_Internal.png`. TestUser has 'internal' grant. Assert HTTP 200.

7. `testAdmin_ConfidentialFile_OriginalPath_Returns200()` -- Admin (sysop, wildcard grant) requests `img_auth.php/E2E_Test_Confidential.png`. Assert HTTP 200.

**Test methods for LEAK-06 (public files accessible to all authenticated):**

8. `testPublicFile_AccessibleToAllAuthenticated()` -- Both Admin and TestUser can access `img_auth.php/E2E_Test_Public.png`. Assert both get HTTP 200.

**Assertion details:**
- For 403 responses: assert status code 403, include descriptive message like "img_auth.php should deny unauthorized access to {level} file for {user}"
- For 200 responses: assert status code 200 AND response body length > 0 (proves actual file bytes were served, not an empty response)
- Do NOT assert on response body content for 403 (MW may or may not include HTML error page depending on $wgImgAuthDetails)
  </action>
  <verify>
- File exists at `tests/phpunit/e2e/ImgAuthLeakTest.php`
- Extends E2ETestBase
- Has 8 test methods covering unauthorized, anonymous, and authorized scenarios
- Covers LEAK-01 (unauthorized original), LEAK-02 (unauthorized thumbnail), LEAK-05 (authorized access), LEAK-06 (public access)
- Uses `@group e2e` annotation
  </verify>
  <done>ImgAuthLeakTest proves that img_auth.php denies unauthorized and anonymous file access (403) while allowing authorized users to download files at their granted levels (200 with file bytes). Both original and thumbnail paths tested.</done>
</task>

<task type="auto">
  <name>Task 2: Create PermissionMatrixTest for exhaustive coverage</name>
  <files>tests/phpunit/e2e/PermissionMatrixTest.php</files>
  <action>
Create `tests/phpunit/e2e/PermissionMatrixTest.php` extending `E2ETestBase`.

This test class satisfies LEAK-07: a full permission matrix covering 3 levels x 3 user types x 2 access vectors. It also produces a human-readable matrix summary for CI output.

**Group annotation:** `@group e2e`

**Matrix dimensions:**
- **Levels:** public, internal, confidential (mapped to test files E2E_Test_Public.png, E2E_Test_Internal.png, E2E_Test_Confidential.png)
- **Users:** Admin (sysop, wildcard grant), TestUser (user group, public+internal only), Anonymous (no cookies)
- **Vectors:** original path (img_auth.php/{file}), thumbnail path (img_auth.php/thumb/{file}/120px-{file})

**Expected results matrix (from LocalSettings.test.php config):**
```
                  | public | internal | confidential
Admin (sysop)     | 200    | 200      | 200
TestUser (user)   | 200    | 200      | 403
Anonymous         | 403    | 403      | 403
```
Both original and thumbnail paths follow the same expected pattern.

**Implementation using data provider:**

Create a static data provider method `permissionMatrixProvider()` that yields all 18 test cases (3 levels x 3 users x 2 vectors):
```php
public static function permissionMatrixProvider(): array {
    // Returns array of [userType, level, vector, expectedStatus]
    // userType: 'admin', 'testuser', 'anonymous'
    // level: 'public', 'internal', 'confidential'
    // vector: 'original', 'thumbnail'
    // expectedStatus: 200 or 403
}
```

Expected status logic:
- Anonymous: always 403 (private wiki blocks all anonymous file access)
- TestUser: 200 for public and internal, 403 for confidential
- Admin: always 200 (sysop wildcard grant)

**Single parameterized test method:**

`testPermissionMatrix(string $userType, string $level, string $vector, int $expectedStatus)`:
1. Get cookies for user type (admin -> admin cookies, testuser -> testuser cookies, anonymous -> empty array)
2. Get URL for vector (original -> `getImgAuthUrl()`, thumbnail -> `getImgAuthThumbUrl()`)
3. Map level to filename using `getTestFileNames()`
4. Make HTTP GET request
5. Assert status code matches expected
6. Assertion message: `"[{$userType}] [{$level}] [{$vector}] expected {$expectedStatus}"`

**Permission matrix summary output:**

After all matrix tests complete, print a human-readable summary table to stdout. Implement this in `tearDownAfterClass()`:

```
=== FilePermissions E2E Permission Matrix ===

               | public  | internal | confidential
  Admin        | OK 200  | OK 200   | OK 200
  TestUser     | OK 200  | OK 200   | OK 403
  Anonymous    | OK 403  | OK 403   | OK 403

Legend: OK = matched expected status
Vectors tested: original, thumbnail (both via img_auth.php)
Total scenarios: 18 (3 levels x 3 users x 2 vectors)
```

Store results in a static array during test execution and format in tearDownAfterClass(). Use `fwrite(STDOUT, ...)` to ensure output appears in PHPUnit even with `--no-output` flags.

**Important:**
- This test class does NOT duplicate the Apache direct-path tests from DirectPathAccessTest. Those are a separate enforcement layer.
- The matrix focuses exclusively on img_auth.php access (the MediaWiki-controlled path).
- On failure, continue running ALL matrix entries (PHPUnit's default behavior with data providers). This shows the full picture of what's leaking, not just the first failure.
  </action>
  <verify>
- File exists at `tests/phpunit/e2e/PermissionMatrixTest.php`
- Extends E2ETestBase
- Has `permissionMatrixProvider()` yielding 18 test cases (3 x 3 x 2)
- Has `testPermissionMatrix()` parameterized test method
- Produces human-readable matrix summary in tearDownAfterClass
- Uses `@group e2e` annotation
- Covers LEAK-07 (full permission matrix)
  </verify>
  <done>PermissionMatrixTest exhaustively covers 3 levels x 3 user types x 2 access vectors = 18 scenarios via img_auth.php, with a human-readable permission matrix summary printed after completion for quick CI scanning.</done>
</task>

</tasks>

<verification>
1. `tests/phpunit/e2e/ImgAuthLeakTest.php` exists with 8 test methods covering LEAK-01, LEAK-02, LEAK-05, LEAK-06
2. `tests/phpunit/e2e/PermissionMatrixTest.php` exists with data provider yielding 18 cases covering LEAK-07
3. Both classes extend E2ETestBase and use `@group e2e`
4. ImgAuthLeakTest verifies both 403 (denial) and 200 (authorized access) with file byte content check
5. PermissionMatrixTest outputs human-readable matrix summary after test run
6. No test halts on first failure -- full picture always shown
</verification>

<success_criteria>
- LEAK-01: Unauthorized user denied confidential original file download via img_auth.php (403)
- LEAK-02: Unauthorized user denied confidential thumbnail via img_auth.php (403)
- LEAK-05: Authorized users can download files at their granted levels (200)
- LEAK-06: Public files accessible to all authenticated users (200)
- LEAK-07: Full 18-scenario permission matrix tested and summarized
- All assertions include descriptive messages for CI debugging
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-http-leak-checks/09-02-SUMMARY.md`
</output>
