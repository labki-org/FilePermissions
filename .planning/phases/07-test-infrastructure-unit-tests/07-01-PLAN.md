---
phase: 07-test-infrastructure-unit-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - extension.json
  - tests/phpunit/unit/ConfigTest.php
autonomous: true

must_haves:
  truths:
    - "TestAutoloadNamespaces in extension.json maps FilePermissions\\Tests\\ to tests/phpunit/"
    - "ConfigTest extends MediaWikiUnitTestCase and is discovered by MW test runner"
    - "Config tests verify correct behavior for valid levels, grants, and defaults"
    - "Config tests verify fail-closed behavior when wgFilePermInvalidConfig is true"
    - "Config tests cover edge cases: empty levels, missing grants, unknown level names, semantic errors"
    - "Every unknown/missing/invalid state test proves access is DENIED (fail-closed)"
  artifacts:
    - path: "extension.json"
      provides: "TestAutoloadNamespaces registration for test discovery"
      contains: "TestAutoloadNamespaces"
    - path: "tests/phpunit/unit/ConfigTest.php"
      provides: "Unit tests for Config class covering UNIT-01, UNIT-02, UNIT-03"
      min_lines: 150
  key_links:
    - from: "extension.json"
      to: "tests/phpunit/"
      via: "TestAutoloadNamespaces"
      pattern: "FilePermissions\\\\Tests\\\\"
    - from: "tests/phpunit/unit/ConfigTest.php"
      to: "includes/Config.php"
      via: "static method calls with $GLOBALS manipulation"
      pattern: "Config::"
---

<objective>
Set up PHPUnit test infrastructure for the FilePermissions extension and implement exhaustive unit tests for the Config class.

Purpose: Establishes test discovery (INFRA-01, INFRA-02) so MW's PHPUnit runner finds FilePermissions tests, and proves Config's permission logic is correct across all valid, invalid, and edge-case configurations (UNIT-01, UNIT-02, UNIT-03).

Output: extension.json with TestAutoloadNamespaces, tests/phpunit/unit/ directory, and ConfigTest.php with ~25-40 test methods.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/Config.php
@extension.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure test infrastructure and autoloading</name>
  <files>extension.json</files>
  <action>
Add the TestAutoloadNamespaces entry to extension.json so MediaWiki's PHPUnit runner discovers FilePermissions test classes automatically.

Add this key at the same level as the existing "AutoloadNamespaces" key:

```json
"TestAutoloadNamespaces": {
    "FilePermissions\\Tests\\": "tests/phpunit/"
},
```

Place it immediately after the existing `"AutoloadNamespaces"` block in extension.json.

Also create the directory structure:
- tests/phpunit/unit/ (for MediaWikiUnitTestCase tests — this plan and plan 07-02)
- tests/phpunit/integration/ (for Phase 8 — create now so the structure is complete)

Verify extension.json is valid JSON after editing (php -r "json_decode(file_get_contents('extension.json'), true); echo json_last_error() === 0 ? 'VALID' : 'INVALID';").
  </action>
  <verify>
1. grep "TestAutoloadNamespaces" extension.json returns the entry
2. tests/phpunit/unit/ directory exists
3. tests/phpunit/integration/ directory exists
4. php -r "json_decode(file_get_contents('extension.json'), true); echo json_last_error() === 0 ? 'VALID' : 'INVALID';" outputs VALID
  </verify>
  <done>extension.json has TestAutoloadNamespaces mapping FilePermissions\Tests\ to tests/phpunit/, and the directory structure exists for unit and integration tests.</done>
</task>

<task type="auto">
  <name>Task 2: Implement exhaustive Config unit tests</name>
  <files>tests/phpunit/unit/ConfigTest.php</files>
  <action>
Create tests/phpunit/unit/ConfigTest.php that extends MediaWikiUnitTestCase.

**Namespace:** `FilePermissions\Tests\Unit`

**Test philosophy:** This extension protects files and data. When in doubt, lean toward MORE exhaustive testing. Security-critical code demands thorough coverage. Fail-closed behavior should be the most visibly tested property — test names should make the security guarantee obvious.

**Pattern for setting config:** Unit tests have no MediaWiki services. Config reads `$GLOBALS['wgFilePermLevels']` etc. directly. Set these globals in each test method (or in setUp with reset in tearDown) to control config state. Reset all 5 globals in tearDown to prevent cross-test pollution:
- `$GLOBALS['wgFilePermLevels']`
- `$GLOBALS['wgFilePermGroupGrants']`
- `$GLOBALS['wgFilePermDefaultLevel']`
- `$GLOBALS['wgFilePermNamespaceDefaults']`
- `$GLOBALS['wgFilePermInvalidConfig']`

**Required test coverage (derive test methods from these requirements):**

UNIT-01 — Valid configuration:
- getLevels() returns configured levels array
- getLevels() deduplicates when MW merges extension.json defaults with LocalSettings values
- getGroupGrants() returns configured group-to-levels map
- getDefaultLevel() returns configured default level string
- getDefaultLevel() returns null when not configured
- getNamespaceDefaults() returns configured namespace-to-level map
- isValidLevel() returns true for a level in the configured list
- isValidLevel() returns false for a level NOT in the configured list
- resolveDefaultLevel() returns namespace-specific default when set and valid
- resolveDefaultLevel() falls back to global default when no namespace default
- resolveDefaultLevel() returns null when no defaults configured
- resolveDefaultLevel() skips invalid namespace default and falls back to global
- resolveDefaultLevel() returns null when global default is invalid level

UNIT-02 — Fail-closed / invalid config:
- isInvalidConfig() returns false when not set (default safe state)
- isInvalidConfig() returns true when $wgFilePermInvalidConfig is true
- getLevels() returns ['public'] when $wgFilePermLevels is null/unset (safe fallback)
- getGroupGrants() returns empty array when $wgFilePermGroupGrants is null/unset (fail-closed: no grants = no access)
- getDefaultLevel() returns null when $wgFilePermDefaultLevel is null/unset
- getNamespaceDefaults() returns empty array when $wgFilePermNamespaceDefaults is null/unset

UNIT-03 — Edge cases:
- getLevels() with empty array returns empty array (zero levels configured)
- getLevels() with single level returns single-element array
- getLevels() with many levels (5+) returns all levels
- getGroupGrants() with group granted empty array (group exists but has no levels)
- getGroupGrants() with group granted wildcard '*' (present in data, tested via isValidLevel or downstream)
- isValidLevel() returns false when levels array is empty (nothing is valid)
- resolveDefaultLevel() with namespace default referencing nonexistent level (semantic error — must not crash, should fall through)
- resolveDefaultLevel() with global default referencing nonexistent level (semantic error — must return null)
- Multiple groups in grants with overlapping levels (data structure test)
- isInvalidConfig() when global is not set at all (unset vs false)

**Naming convention:** Use descriptive test method names that make the security guarantee obvious. Examples:
- `testGetLevelsReturnsConfiguredLevels`
- `testIsInvalidConfigReturnsFalseByDefault`
- `testGetGroupGrantsReturnsEmptyArrayWhenUnset_NoGrantsMeansNoAccess`
- `testResolveDefaultLevelSkipsInvalidNamespaceDefault`

Use `@covers` annotations on each test method pointing to the specific Config method being tested.

Use `@dataProvider` for parameterized cases where it reduces duplication (e.g., testing isValidLevel with valid and invalid inputs). Data providers MUST be static methods (PHPUnit 10 future compatibility).
  </action>
  <verify>
1. File exists at tests/phpunit/unit/ConfigTest.php
2. Class extends MediaWikiUnitTestCase
3. Namespace is FilePermissions\Tests\Unit
4. Test count: at minimum 25 test methods (or data-provider-powered equivalents covering 25+ scenarios)
5. Every Config:: public static method has at least one @covers annotation pointing to it
6. tearDown resets all 5 $GLOBALS to prevent cross-test pollution
7. Fail-closed tests are present and named to make security guarantees visible
  </verify>
  <done>ConfigTest.php covers all UNIT-01 (valid config), UNIT-02 (fail-closed/invalid), and UNIT-03 (edge cases) requirements with 25+ test scenarios. Every Config method has test coverage. Fail-closed behavior is explicitly tested and visible in test names.</done>
</task>

</tasks>

<verification>
1. extension.json has TestAutoloadNamespaces with correct mapping
2. tests/phpunit/unit/ConfigTest.php exists, extends MediaWikiUnitTestCase, is in correct namespace
3. Config test coverage spans all 7 public methods of Config class
4. Test count >= 25 scenarios (methods + data provider rows)
5. Fail-closed tests explicitly verify denial behavior
6. All globals are properly reset in tearDown
</verification>

<success_criteria>
- TestAutoloadNamespaces correctly configured in extension.json
- ConfigTest.php has 25+ test scenarios covering valid config, fail-closed, and edge cases
- Every public Config method has @covers test coverage
- Test names make security guarantees visible (fail-closed behavior is obvious)
- No shared mutable state between tests (globals reset in tearDown)
</success_criteria>

<output>
After completion, create `.planning/phases/07-test-infrastructure-unit-tests/07-01-SUMMARY.md`
</output>
