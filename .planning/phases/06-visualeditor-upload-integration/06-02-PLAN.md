---
phase: 06-visualeditor-upload-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - modules/ext.FilePermissions.visualeditor.js
  - modules/ext.FilePermissions.visualeditor.css
autonomous: true

must_haves:
  truths:
    - "Permission dropdown appears in VisualEditor's upload dialog info form"
    - "Dropdown defaults based on current page namespace"
    - "Selected permission level is transmitted with the publish-from-stash API request"
    - "Uploaded file has selected permission level stored in PageProps"
    - "Upload without explicit selection uses namespace/global default"
    - "Dropdown resets to default when VE dialog is reused"
    - "Dropdown is skipped for foreign upload targets"
  artifacts:
    - path: "modules/ext.FilePermissions.visualeditor.js"
      provides: "VE bridge: BookletLayout monkey-patch, XHR interception, post-upload verification"
      min_lines: 80
    - path: "modules/ext.FilePermissions.visualeditor.css"
      provides: "Dropdown styling within VE upload dialog"
      min_lines: 10
  key_links:
    - from: "modules/ext.FilePermissions.visualeditor.js"
      to: "mw.ForeignStructuredUpload.BookletLayout.prototype.renderInfoForm"
      via: "Monkey-patch to inject OOUI DropdownInputWidget"
      pattern: "origRenderInfoForm"
    - from: "modules/ext.FilePermissions.visualeditor.js"
      to: "XMLHttpRequest.prototype.send"
      via: "XHR interception to append wpFilePermLevel on publish-from-stash"
      pattern: "origSend.*XMLHttpRequest"
    - from: "modules/ext.FilePermissions.visualeditor.js"
      to: "mw.ForeignStructuredUpload.BookletLayout.prototype.clear"
      via: "Monkey-patch to reset dropdown on dialog reuse"
      pattern: "origClear"
    - from: "XHR interceptor wpFilePermLevel"
      to: "includes/Hooks/UploadHooks.php onUploadVerifyUpload"
      via: "API POST parameter in publish-from-stash request"
      pattern: "wpFilePermLevel"
---

<objective>
Create the VisualEditor bridge JavaScript module and CSS that injects a permission dropdown into VE's upload dialog, intercepts the publish-from-stash XHR to transmit the selected level, and verifies PageProps storage after upload.

Purpose: Enables users to set file permission levels when uploading via VisualEditor, completing the last upload integration path.
Output: ext.FilePermissions.visualeditor.js (bridge module) and ext.FilePermissions.visualeditor.css (dropdown styling).
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-visualeditor-upload-integration/06-RESEARCH.md

# Server-side foundation created in Plan 01
@.planning/phases/06-visualeditor-upload-integration/06-01-SUMMARY.md

# MsUpload bridge for pattern reference (XHR patching, post-upload verification)
@modules/ext.FilePermissions.msupload.js
@modules/ext.FilePermissions.msupload.css

# Server-side hooks that receive wpFilePermLevel (no changes needed, just for understanding)
@includes/Hooks/UploadHooks.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ext.FilePermissions.visualeditor.js bridge module</name>
  <files>
    modules/ext.FilePermissions.visualeditor.js
  </files>
  <action>
Create `modules/ext.FilePermissions.visualeditor.js` as an IIFE with 'use strict'. The module has three parts:

**PART 0: Guard and config**
- Read `mw.config.get('wgFilePermLevels')` into `levels` variable
- Read `mw.config.get('wgFilePermVEDefault')` into `defaultLevel` variable
- Early return if `!levels || !levels.length` (no levels configured)

**PART 1: Monkey-patch BookletLayout.prototype.renderInfoForm**
- Store original: `var origRenderInfoForm = mw.ForeignStructuredUpload.BookletLayout.prototype.renderInfoForm;`
- Replace with function that:
  1. Calls `origRenderInfoForm.call(this)` to get the original form panel
  2. Checks `this.upload && this.upload.target !== 'local'` — if NOT local, return form unchanged (skip dropdown for foreign uploads, per Pitfall 7)
  3. Creates `this.filePermDropdown = new OO.ui.DropdownInputWidget({...})` with:
     - `options`: map `levels` array to `{data: lvl, label: lvl}` objects
     - `value`: `defaultLevel || levels[0]`
     - `classes`: `['fileperm-ve-dropdown']` (for CSS targeting)
  4. Creates `fieldLayout = new OO.ui.FieldLayout(this.filePermDropdown, { label: mw.msg('filepermissions-ve-label'), align: 'top' })`
  5. Appends `fieldLayout.$element` to `form.$element.find('.oo-ui-fieldsetLayout')` — this inserts the dropdown into the existing info form fieldset
  6. Returns form

**Also monkey-patch BookletLayout.prototype.clear** (dialog reuse fix, per Pitfall 6):
- Store original: `var origClear = mw.ForeignStructuredUpload.BookletLayout.prototype.clear;`
- Replace with function that:
  1. Calls `origClear.call(this)`
  2. If `this.filePermDropdown`, resets value: `this.filePermDropdown.setValue(defaultLevel || levels[0])`

**PART 2: XHR prototype patching for publish-from-stash parameter injection**
Follow the same pattern as `ext.FilePermissions.msupload.js` but target the PUBLISH step specifically:

- `getSelectedPermLevel()` function:
  - Access the BookletLayout instance's dropdown. Since we cannot easily get the instance reference from the XHR interceptor, query the DOM: `$('.fileperm-ve-dropdown')` finds the OOUI widget container
  - Use `OO.ui.infuse()` to get the widget if it has `data-ooui` attribute, OR find the inner `<select>` within the OOUI widget and read its value directly
  - BETTER approach (recommended): Use a module-level variable `var activeDropdown = null;` set in renderInfoForm (`activeDropdown = this.filePermDropdown;`) and read in getSelectedPermLevel (`return activeDropdown ? activeDropdown.getValue() : (defaultLevel || levels[0]);`). This avoids DOM queries and works regardless of panel visibility.
  - Fallback: return `defaultLevel || levels[0]`

- Patch `XMLHttpRequest.prototype.open`:
  ```javascript
  var origOpen = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function (method, url) {
      if (method === 'POST' && url && url.indexOf('api.php') !== -1) {
          this._filePermIsApiPost = true;
      }
      return origOpen.apply(this, arguments);
  };
  ```

- Patch `XMLHttpRequest.prototype.send`:
  ```javascript
  var origSend = XMLHttpRequest.prototype.send;
  XMLHttpRequest.prototype.send = function (body) {
      if (this._filePermIsApiPost && body instanceof FormData) {
          var isUpload = body.get('action') === 'upload';
          var hasFilekey = !!body.get('filekey');
          // CRITICAL: Only inject on publish-from-stash (action=upload + filekey present)
          // This distinguishes VE's publish step from the initial stash upload
          if (isUpload && hasFilekey && !body.get('wpFilePermLevel')) {
              body.append('wpFilePermLevel', getSelectedPermLevel());
          }
      }
      return origSend.apply(this, arguments);
  };
  ```

**PART 3: Post-upload verification (same pattern as MsUpload bridge)**

Hook into the BookletLayout's upload success to verify PageProps storage. Monkey-patch `BookletLayout.prototype.setPage` or listen for state changes. Simpler approach: add a `saveFile` wrapper:

- Store original: `var origSaveFile = mw.ForeignStructuredUpload.BookletLayout.prototype.saveFile;`
- Replace with function that:
  1. Returns `origSaveFile.call(this).then(function() { verifyPermission(self.getFilename()); })` — verify after save completes
  2. Store `var self = this;` before the return

- `verifyPermission(filename)` function (copied from MsUpload bridge pattern):
  ```javascript
  function verifyPermission(filename) {
      new mw.Api().get({
          action: 'query',
          titles: 'File:' + filename,
          prop: 'pageprops',
          ppprop: 'fileperm_level'
      }).then(function (data) {
          if (!data.query || !data.query.pages) return;
          var pages = data.query.pages;
          for (var pageId in pages) {
              var page = pages[pageId];
              if (!page.pageprops || !page.pageprops.fileperm_level) {
                  mw.notify(
                      mw.msg('filepermissions-ve-error-save', filename),
                      { type: 'error', autoHide: false }
                  );
              }
          }
      });
  }
  ```

**XHR coexistence note:** Both MsUpload and VE bridges may load on the same page. Each wraps the previous XMLHttpRequest.prototype.open/send. This is standard monkey-patching — each wrapper stores and calls through to the previous version. The `!body.get('wpFilePermLevel')` guard prevents double-injection. The MsUpload bridge targets `action=upload` WITHOUT filekey (direct upload); the VE bridge targets `action=upload` WITH filekey (publish from stash). They target different upload flows and coexist correctly.

**IMPORTANT — What NOT to do:**
- Do NOT inject wpFilePermLevel during the stash upload phase. The `fieldsAllowed` allowlist in `mw.Api.uploadWithFormData()` strips unknown params during stash. Only inject during publish (action=upload + filekey).
- Do NOT use plain HTML select. VE's dialog is entirely OOUI. Use `OO.ui.DropdownInputWidget`.
- Do NOT declare ext.visualEditor modules as RL dependencies. Server-side `ExtensionRegistry` handles conditional loading.
- Do NOT attempt to subclass BookletLayout — VE's MWMediaDialog hard-codes `new mw.ForeignStructuredUpload.BookletLayout(...)`.
  </action>
  <verify>
Run `node --check modules/ext.FilePermissions.visualeditor.js` (or `node -e "require('fs').readFileSync('modules/ext.FilePermissions.visualeditor.js','utf8')"`) to confirm no syntax errors.
Grep for key patterns:
- `origRenderInfoForm` (renderInfoForm monkey-patch)
- `origClear` (clear monkey-patch for dialog reuse)
- `origOpen` and `origSend` (XHR interception)
- `filekey` (publish-from-stash detection)
- `wpFilePermLevel` (parameter injection)
- `fileperm_level` (PageProps verification)
- `OO.ui.DropdownInputWidget` (OOUI dropdown, not plain HTML select)
- `this.upload.target !== 'local'` (foreign upload guard)
  </verify>
  <done>
ext.FilePermissions.visualeditor.js exists with:
1. BookletLayout.renderInfoForm monkey-patch injecting OOUI DropdownInputWidget
2. BookletLayout.clear monkey-patch resetting dropdown on dialog reuse
3. XHR interception injecting wpFilePermLevel on publish-from-stash requests only
4. Post-upload PageProps verification with persistent error notification
5. Foreign upload target guard (dropdown skipped when target !== 'local')
6. Namespace-aware default from wgFilePermVEDefault
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ext.FilePermissions.visualeditor.css styling</name>
  <files>
    modules/ext.FilePermissions.visualeditor.css
  </files>
  <action>
Create `modules/ext.FilePermissions.visualeditor.css` with styling for the permission dropdown within VE's upload dialog.

Since VE's dialog is entirely OOUI, the dropdown widget inherits OOUI styling automatically. The CSS needs only minor adjustments:

1. `.fileperm-ve-dropdown` — the container class added to the DropdownInputWidget:
   - `margin-top: 0.5em;` — spacing from the field above
   - `max-width: 300px;` — prevent dropdown from stretching full dialog width

2. `.fileperm-ve-dropdown .oo-ui-dropdownInputWidget` — target the inner OOUI element if needed for alignment tweaks

3. Disabled state (during upload): `.fileperm-ve-dropdown.oo-ui-widget-disabled` — OOUI handles disabled styling natively, but add `opacity: 0.6;` if needed for visual clarity

Keep the CSS minimal. OOUI widgets in VE dialogs have extensive built-in styling. Over-styling will clash with VE's theme.

Reference `ext.FilePermissions.msupload.css` for the general approach, but note: MsUpload bridge uses plain HTML styling (plain select element), while VE bridge uses OOUI (which provides its own styling). The VE CSS should be significantly shorter.
  </action>
  <verify>
Confirm file exists and is non-empty.
Grep for `.fileperm-ve-dropdown` class selector.
Verify no syntax errors (balanced braces, valid CSS properties).
  </verify>
  <done>
ext.FilePermissions.visualeditor.css exists with dropdown styling that integrates cleanly with VE's OOUI dialog, including spacing and width constraints.
  </done>
</task>

</tasks>

<verification>
1. `node --check modules/ext.FilePermissions.visualeditor.js` — no syntax errors
2. ext.FilePermissions.visualeditor.js contains all five required patterns: renderInfoForm patch, clear patch, XHR open/send interception, publish-from-stash detection (filekey), post-upload verification
3. ext.FilePermissions.visualeditor.css exists with .fileperm-ve-dropdown styling
4. OOUI DropdownInputWidget is used (not plain HTML select)
5. Foreign upload target guard present (this.upload.target !== 'local')
6. XHR interceptor only targets publish-from-stash (action=upload AND filekey present)
7. Post-upload verification queries PageProps and shows persistent error on failure
</verification>

<success_criteria>
- JS bridge module monkey-patches BookletLayout.renderInfoForm to add OOUI permission dropdown
- Dropdown defaults to namespace-resolved default from wgFilePermVEDefault
- XHR interception injects wpFilePermLevel into publish-from-stash API POST only
- Dialog reuse resets dropdown via clear() monkey-patch
- Foreign upload targets skip dropdown injection
- Post-upload PageProps verification with persistent mw.notify error
- CSS provides clean integration with VE dialog styling
</success_criteria>

<output>
After completion, create `.planning/phases/06-visualeditor-upload-integration/06-02-SUMMARY.md`
</output>
