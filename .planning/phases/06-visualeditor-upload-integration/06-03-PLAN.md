---
phase: 06-visualeditor-upload-integration
plan: 03
type: execute
wave: 1
depends_on: ["06-02"]
files_modified:
  - modules/ext.FilePermissions.visualeditor.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "XHR send() interceptor handles both FormData and URL-encoded string bodies"
    - "wpFilePermLevel is injected into publish-from-stash requests regardless of body serialization format"
    - "Existing FormData handling for MsUpload coexistence is preserved"
  artifacts:
    - path: "modules/ext.FilePermissions.visualeditor.js"
      provides: "Fixed XHR interception supporting string body type"
      contains: "typeof body === 'string'"
---

<objective>
Fix VE bridge XHR interception to handle URL-encoded string bodies from mw.Api.uploadFromStash.

Root cause: mw.Api.uploadFromStash() calls postWithEditToken() without contentType:'multipart/form-data', so mw.Api.ajax() serializes parameters via $.param() producing a URL-encoded string â€” not FormData. Our interceptor only handles FormData.

Fix: Extend the send() patch to also parse and inject into string bodies when they contain action=upload&filekey=.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Fix XHR send() interceptor to handle string bodies</name>
  <files>modules/ext.FilePermissions.visualeditor.js</files>
  <action>
In `modules/ext.FilePermissions.visualeditor.js`, modify the `XMLHttpRequest.prototype.send` patch (currently lines 148-164) to handle both body types:

Current code (lines 149-161):
```javascript
XMLHttpRequest.prototype.send = function ( body ) {
    if ( this._filePermIsApiPost && body instanceof FormData ) {
        var isUpload = ( typeof body.get === 'function' ) &&
            body.get( 'action' ) === 'upload';
        var hasFilekey = ( typeof body.get === 'function' ) &&
            !!body.get( 'filekey' );

        if ( isUpload && hasFilekey && !body.get( 'wpFilePermLevel' ) ) {
            body.append( 'wpFilePermLevel', getSelectedPermLevel() );
        }
    }

    return origSend.apply( this, arguments );
};
```

Replace with code that handles BOTH FormData and string bodies:

```javascript
XMLHttpRequest.prototype.send = function ( body ) {
    if ( this._filePermIsApiPost ) {
        if ( body instanceof FormData ) {
            // MsUpload path: plupload sends FormData directly
            var isUpload = ( typeof body.get === 'function' ) &&
                body.get( 'action' ) === 'upload';
            var hasFilekey = ( typeof body.get === 'function' ) &&
                !!body.get( 'filekey' );

            if ( isUpload && hasFilekey && !body.get( 'wpFilePermLevel' ) ) {
                body.append( 'wpFilePermLevel', getSelectedPermLevel() );
            }
        } else if ( typeof body === 'string' ) {
            // VE path: mw.Api serializes as URL-encoded string
            // Parse to check for publish-from-stash (action=upload + filekey)
            var params = new URLSearchParams( body );
            if ( params.get( 'action' ) === 'upload' &&
                params.has( 'filekey' ) &&
                !params.has( 'wpFilePermLevel' ) ) {
                params.set( 'wpFilePermLevel', getSelectedPermLevel() );
                body = params.toString();
                // Must pass modified body to original send
                return origSend.call( this, body );
            }
        }
    }

    return origSend.apply( this, arguments );
};
```

Key changes:
1. Outer if checks `this._filePermIsApiPost` only (no body type check)
2. Inner `body instanceof FormData` branch preserved for MsUpload coexistence
3. New `typeof body === 'string'` branch handles VE's URL-encoded path
4. Uses `URLSearchParams` to parse/modify the string (native browser API, available in all supported MW browsers)
5. Returns `origSend.call(this, body)` with modified body string (can't use `apply(this, arguments)` since we modified body)

Also update the PART 2 comment block to reflect the dual-format handling.
  </action>
  <verify>
Run `node --check modules/ext.FilePermissions.visualeditor.js` to confirm no syntax errors.
Grep for `typeof body === 'string'` to confirm string handling is present.
Grep for `URLSearchParams` to confirm URL-encoded parsing.
Grep for `body instanceof FormData` to confirm FormData path is preserved.
  </verify>
  <done>XHR send() interceptor handles both FormData (MsUpload) and URL-encoded string (VE) body types.</done>
</task>

</tasks>
</plan>
