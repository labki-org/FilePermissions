---
phase: 06-visualeditor-upload-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/Hooks/VisualEditorHooks.php
  - extension.json
  - i18n/en.json
autonomous: true

must_haves:
  truths:
    - "VE bridge module loads only when VisualEditor extension is installed"
    - "VE bridge module receives permission levels and namespace default via JS config vars"
    - "ext.FilePermissions.visualeditor is registered with correct RL dependencies"
    - "VE-specific i18n messages are available for the bridge module"
  artifacts:
    - path: "includes/Hooks/VisualEditorHooks.php"
      provides: "BeforePageDisplay handler for conditional VE bridge loading"
      contains: "ExtensionRegistry::getInstance()->isLoaded( 'VisualEditor' )"
    - path: "extension.json"
      provides: "HookHandler registration, Hook binding, ResourceModule definition"
      contains: "ext.FilePermissions.visualeditor"
    - path: "i18n/en.json"
      provides: "VE bridge i18n messages"
      contains: "filepermissions-ve-label"
  key_links:
    - from: "extension.json"
      to: "includes/Hooks/VisualEditorHooks.php"
      via: "HookHandlers.visualeditor class reference"
      pattern: "FilePermissions\\\\Hooks\\\\VisualEditorHooks"
    - from: "extension.json"
      to: "Hooks.BeforePageDisplay"
      via: "Hook binding array includes visualeditor handler"
      pattern: "\"BeforePageDisplay\".*visualeditor"
    - from: "extension.json"
      to: "modules/ext.FilePermissions.visualeditor.js"
      via: "ResourceModules.ext.FilePermissions.visualeditor packageFiles"
      pattern: "ext\\.FilePermissions\\.visualeditor\\.js"
---

<objective>
Register VisualEditorHooks handler, VE bridge ResourceLoader module, and i18n messages for the VisualEditor upload integration.

Purpose: Server-side foundation that enables the client-side VE bridge module (Plan 02) to load conditionally when VisualEditor is installed, with access to permission levels and namespace defaults.
Output: VisualEditorHooks.php, updated extension.json (HookHandler + Hook + ResourceModule), updated i18n/en.json with VE messages.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-visualeditor-upload-integration/06-RESEARCH.md

# Prior phase reference — same pattern being replicated
@.planning/phases/05-msupload-integration/05-01-SUMMARY.md

# Source files to reference for pattern consistency
@includes/Hooks/MsUploadHooks.php
@extension.json
@i18n/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VisualEditorHooks.php and register in extension.json</name>
  <files>
    includes/Hooks/VisualEditorHooks.php
    extension.json
  </files>
  <action>
Create `includes/Hooks/VisualEditorHooks.php` following the exact pattern of `MsUploadHooks.php`:

1. Namespace `FilePermissions\Hooks`, `declare(strict_types: 1)`
2. Implement `BeforePageDisplayHook` (not EditPage hook — VE loads on any content page, not just edit pages)
3. Use `MediaWiki\Output\Hook\BeforePageDisplayHook` interface
4. In `onBeforePageDisplay($out, $skin)`:
   - Early return if `ExtensionRegistry::getInstance()->isLoaded('VisualEditor')` is false
   - Get namespace from `$out->getTitle()->getNamespace()`
   - Call `$out->addModules(['ext.FilePermissions.visualeditor'])`
   - Call `$out->addJsConfigVars()` with:
     - `wgFilePermLevels` => `Config::getLevels()`
     - `wgFilePermVEDefault` => `Config::resolveDefaultLevel($ns)`

Key differences from MsUploadHooks:
- Uses `BeforePageDisplayHook` (not `EditPage__showEditForm_initialHook`) because VE can be opened on any content page, not just edit form pages
- Config var is `wgFilePermVEDefault` (not `wgFilePermMsUploadDefault`)
- Checks for `'VisualEditor'` (not `'MsUpload'`)

Then update `extension.json`:

1. Add HookHandler entry:
   ```json
   "visualeditor": {
       "class": "FilePermissions\\Hooks\\VisualEditorHooks"
   }
   ```
   (No services needed — uses static Config methods only, same as MsUploadHooks)

2. Update BeforePageDisplay hook to include both handlers. The current value is:
   ```json
   "BeforePageDisplay": "display"
   ```
   Change to array format:
   ```json
   "BeforePageDisplay": ["display", "visualeditor"]
   ```
   This allows both DisplayHooks and VisualEditorHooks to handle the same hook.

3. Add ResourceModule `ext.FilePermissions.visualeditor`:
   ```json
   "ext.FilePermissions.visualeditor": {
       "localBasePath": "modules",
       "remoteExtPath": "FilePermissions/modules",
       "packageFiles": [
           "ext.FilePermissions.visualeditor.js"
       ],
       "styles": [
           "ext.FilePermissions.visualeditor.css"
       ],
       "dependencies": [
           "mediawiki.api",
           "oojs-ui-core",
           "mediawiki.ForeignStructuredUpload.BookletLayout"
       ],
       "messages": [
           "filepermissions-ve-label",
           "filepermissions-ve-error-nolevels",
           "filepermissions-ve-error-save"
       ]
   }
   ```
   Key: `mediawiki.ForeignStructuredUpload.BookletLayout` IS a hard dependency (it is a MediaWiki core module, always available when VE is installed). This ensures our prototype patch runs after the BookletLayout class is defined.

Do NOT declare any dependency on ext.visualEditor modules — our server-side `ExtensionRegistry::isLoaded('VisualEditor')` check handles conditional loading.
  </action>
  <verify>
Run `php -l includes/Hooks/VisualEditorHooks.php` to confirm no syntax errors.
Run `python3 -m json.tool extension.json` (or `jq . extension.json`) to confirm valid JSON.
Grep extension.json for "visualeditor" to confirm HookHandler, Hook binding, and ResourceModule are all present.
Verify BeforePageDisplay hook value is an array containing both "display" and "visualeditor".
  </verify>
  <done>
VisualEditorHooks.php exists with BeforePageDisplay handler that conditionally loads VE bridge module.
extension.json contains: visualeditor HookHandler, BeforePageDisplay array with both handlers, ext.FilePermissions.visualeditor ResourceModule with correct dependencies and messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add VE bridge i18n messages</name>
  <files>
    i18n/en.json
  </files>
  <action>
Add three new i18n messages to `i18n/en.json`, following the naming pattern of existing MsUpload messages:

```json
"filepermissions-ve-label": "Permission level:",
"filepermissions-ve-error-nolevels": "Error: Permission levels could not be loaded.",
"filepermissions-ve-error-save": "Warning: File uploaded but permission level may not have been saved for \"$1\". Check the file page."
```

Place these after the existing `filepermissions-msupload-*` messages.

The messages mirror the MsUpload bridge messages exactly (same user-facing text). The VE-specific prefix (`ve`) allows future differentiation if VE needs different wording.

Ensure valid JSON after editing (no trailing commas, proper escaping of quotes in the error-save message).
  </action>
  <verify>
Run `python3 -m json.tool i18n/en.json` (or `jq . i18n/en.json`) to confirm valid JSON.
Grep i18n/en.json for "filepermissions-ve-" to confirm all three messages exist.
  </verify>
  <done>
i18n/en.json contains filepermissions-ve-label, filepermissions-ve-error-nolevels, and filepermissions-ve-error-save messages.
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/Hooks/VisualEditorHooks.php` — no syntax errors
2. `python3 -m json.tool extension.json` — valid JSON
3. `python3 -m json.tool i18n/en.json` — valid JSON
4. extension.json HookHandlers contains "visualeditor" key
5. extension.json Hooks.BeforePageDisplay is array containing "display" and "visualeditor"
6. extension.json ResourceModules contains "ext.FilePermissions.visualeditor" with mediawiki.ForeignStructuredUpload.BookletLayout dependency
7. i18n/en.json contains all three filepermissions-ve-* messages
</verification>

<success_criteria>
- VisualEditorHooks.php matches MsUploadHooks.php pattern (ExtensionRegistry check, addModules, addJsConfigVars)
- extension.json is valid and contains all VE-related registrations
- i18n messages registered for VE bridge module consumption
- No hard dependency on VisualEditor extension modules (conditional loading only)
</success_criteria>

<output>
After completion, create `.planning/phases/06-visualeditor-upload-integration/06-01-SUMMARY.md`
</output>
