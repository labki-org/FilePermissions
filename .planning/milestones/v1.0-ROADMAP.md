# Milestone v1.0: FilePermissions MVP

**Status:** SHIPPED 2026-01-29
**Phases:** 1-6
**Total Plans:** 13 (12 planned + 1 gap closure)

## Overview

FilePermissions delivers group-based, byte-level access control for MediaWiki uploaded files. The roadmap follows an infrastructure-first, enforcement-before-UI strategy: web server configuration and permission storage come first, then hook-based enforcement, then user-facing upload and management interfaces. This ordering ensures no security windows where UI exists but enforcement is incomplete.

## Phases

### Phase 1: Foundation & Infrastructure

**Goal**: Establish the permission model, configuration system, and storage layer that all other phases depend on
**Depends on**: Nothing (first phase)
**Requirements**: PERM-01, PERM-02, PERM-03, PERM-04, PERM-05, PERM-06, PERM-07, PERM-08, CONF-01, CONF-02
**Success Criteria**:
  1. Permission levels can be configured via LocalSettings.php ($wgFilePermLevels)
  2. Group-to-level grants can be configured via LocalSettings.php ($wgFilePermGroupGrants)
  3. Extension validates configuration on load and fails closed on invalid config
  4. A file's permission level can be stored and retrieved from PageProps
  5. Default permission levels resolve correctly (global default, namespace override, fallback)
**Plans**: 2 plans
**Completed**: 2026-01-28

Plans:
- [x] 01-01-PLAN.md - Extension skeleton & configuration system
- [x] 01-02-PLAN.md - Permission service & PageProps storage

### Phase 2: Core Enforcement

**Goal**: Unauthorized users cannot access protected files through any content path
**Depends on**: Phase 1
**Requirements**: ENFC-01, ENFC-02, ENFC-03, ENFC-04, ENFC-05
**Success Criteria**:
  1. Unauthorized user receives permission error when viewing File: description page
  2. Unauthorized user receives 403 when requesting raw file via img_auth.php
  3. Unauthorized user receives 403 when requesting thumbnail via img_auth.php
  4. Embedded images fail to render for unauthorized users (broken image or placeholder)
  5. Permission check correctly falls back to default level for files without explicit permission
**Plans**: 2 plans
**Completed**: 2026-01-28

Plans:
- [x] 02-01-PLAN.md - Enforcement hooks (getUserPermissionsErrors, ImgAuthBeforeStream, ImageBeforeProduceHTML)
- [x] 02-02-PLAN.md - Human verification of all access paths

### Phase 3: Upload Integration

**Goal**: Users can set permission level when uploading files via Special:Upload
**Depends on**: Phase 2
**Requirements**: UPLD-01, UPLD-02, UPLD-03, UPLD-04
**Success Criteria**:
  1. Permission dropdown appears on Special:Upload form
  2. Dropdown options match configured $wgFilePermLevels
  3. Default selection reflects namespace context or global default
  4. Uploaded file has selected permission level stored in PageProps
**Plans**: 1 plan
**Completed**: 2026-01-29

Plans:
- [x] 03-01-PLAN.md - Upload form dropdown + permission storage on upload

### Phase 4: Display & Management

**Goal**: Users can see file permissions and admins can change them on File pages
**Depends on**: Phase 3
**Requirements**: FPUI-01, FPUI-02, FPUI-03
**Success Criteria**:
  1. Permission level badge/indicator visible on File: description pages
  2. Sysop users see permission edit interface (dropdown + save) on File pages
  3. Sysop can change permission level and change persists to PageProps
**Plans**: 2 plans
**Completed**: 2026-01-29

Plans:
- [x] 04-01-PLAN.md - Backend hooks, API module, extension registration, and i18n
- [x] 04-02-PLAN.md - Frontend JS/CSS and human verification

### Phase 5: MsUpload Integration

**Goal**: Users can set permission level when uploading files via MsUpload drag-drop
**Depends on**: Phase 4
**Requirements**: MSUP-01, MSUP-02, MSUP-03, MSUP-04, MSUP-05
**Success Criteria**:
  1. Permission dropdown appears in MsUpload toolbar when MsUpload is present
  2. Dropdown defaults based on current page namespace
  3. Selected permission level is transmitted with upload request
  4. Uploaded file has selected permission level stored in PageProps
  5. Upload without selection uses namespace/global default
**Plans**: 2 plans
**Completed**: 2026-01-29

Plans:
- [x] 05-01-PLAN.md - Server-side fix (UploadVerifyUpload tolerance) + MsUpload hook handler + module registration + i18n
- [x] 05-02-PLAN.md - Client-side MsUpload bridge JS/CSS (dropdown, plupload event binding, verification)

### Phase 6: VisualEditor Upload Integration

**Goal**: Users can set permission level when uploading files via VisualEditor
**Depends on**: Phase 5
**Success Criteria**:
  1. Permission dropdown appears in VisualEditor's upload dialog
  2. Dropdown defaults based on current page namespace
  3. Selected permission level is transmitted with upload request
  4. Uploaded file has selected permission level stored in PageProps
  5. Upload without selection uses namespace/global default
**Plans**: 3 plans (2 planned + 1 gap closure)
**Completed**: 2026-01-29

Plans:
- [x] 06-01-PLAN.md - Server-side hooks, VE bridge module registration, and i18n messages
- [x] 06-02-PLAN.md - Client-side VE bridge JS/CSS (BookletLayout monkey-patch, XHR interception, verification)
- [x] 06-03-PLAN.md - XHR body type fix (URL-encoded string handling for publish-from-stash)

---

## Milestone Summary

**Key Decisions:**
- PageProps for storage (fast lookup, cached, native MW infrastructure)
- Single permission level per file (simple mental model)
- JS bridge for MsUpload (avoids forking, uses existing events/hooks)
- Group-based only (reduces complexity, aligns with MW permission model)
- Fail-closed via global flag (wiki loads but denies all access on invalid config)
- DeferredUpdates for PageProps storage (page not committed when UploadComplete fires)
- UploadVerifyUploadHook for validation (UploadForm bypasses HTMLForm validation)
- OOUI server-side rendering for edit controls (not Codex/Vue)
- Custom edit-fileperm right (MW convention, allows admin reassignment)
- ManualLogEntry audit logging for permission changes
- Direct multipart_params mutation for MsUpload (setOption would overwrite params)
- BookletLayout monkey-patching for VE (OOUI dropdown injection)
- XHR prototype patching for VE (publish-from-stash interception with filekey guard)
- URLSearchParams for string body parsing (VE uses URL-encoded, not FormData)

**Issues Resolved:**
- Missing MessagesDirs in extension.json
- Parser cache serving stale permissions (fixed with updateCacheExpiry(0))
- SVG data URI escaping (fixed with base64 encoding)
- UploadCompleteHook signature mismatch (MW 1.44 interface difference)
- Duplicate levels from MW array config merging (fixed with array_unique)
- UploadForm bypassing HTMLForm validation (fixed with UploadVerifyUpload hook)
- PageProps storage failing at articleID=0 (fixed with DeferredUpdates + fresh Title)
- Non-existent ImagePageAfterImageLinksHook interface (removed declaration)
- JS executing before DOM ready (wrapped in jQuery ready handler)
- OOUI widgets not interactive without infusion (added OO.ui.infuse)
- Non-existent mediawiki.notify RL module (removed dependency)
- OOUI widgets missing infusable flag (added infusable: true)
- MsUpload bridge race condition (resolved during UAT)
- VE XHR body type mismatch (URL-encoded string vs FormData)

**Technical Debt Incurred:**
- Orphaned PermissionService::removeLevel() method (no consumer)
- Orphaned filepermissions-ve-error-nolevels i18n message (VE bridge silently returns instead of displaying)
- Phases 3 and 4 lack formal VERIFICATION.md files (verified via SUMMARY human checks)
- Parser cache disabled for pages with protected embedded images (performance tradeoff)

---

_For current project status, see .planning/MILESTONES.md_
