---
milestone: v1
audited: 2026-01-29
status: tech_debt
scores:
  requirements: 27/27
  phases: 6/6
  integration: 14/14
  flows: 5/5
gaps: []
tech_debt:
  - phase: 03-upload-integration
    items:
      - "Missing formal VERIFICATION.md (verified via SUMMARY.md human verification results)"
  - phase: 04-display-management
    items:
      - "Missing formal VERIFICATION.md (verified via SUMMARY.md human verification results)"
      - "Steps 9-11 of verification plan deferred (non-sysop view, file without level)"
  - phase: 06-visualeditor-upload-integration
    items:
      - "Orphaned i18n message: filepermissions-ve-error-nolevels defined but never used in VE bridge JS"
  - phase: 01-foundation-infrastructure
    items:
      - "Orphaned method: PermissionService::removeLevel() defined but no consumer in current codebase"
---

# v1 Milestone Audit Report

**Milestone:** v1 — FilePermissions MediaWiki Extension
**Audited:** 2026-01-29
**Status:** TECH DEBT (all requirements met, no blockers, minor accumulated debt)

## Requirements Coverage

All 27 v1 requirements satisfied across 6 phases.

| Requirement | Description | Phase | Status |
|-------------|-------------|-------|--------|
| PERM-01 | Store permission level in PageProps | 1 | Satisfied |
| PERM-02 | Levels configurable via $wgFilePermLevels | 1 | Satisfied |
| PERM-03 | Group-to-level mapping via $wgFilePermGroupGrants | 1 | Satisfied |
| PERM-04 | Wildcard '*' grants access to all levels | 1 | Satisfied |
| PERM-05 | Effective permissions = union of group grants | 1 | Satisfied |
| PERM-06 | Global default via $wgFilePermDefaultLevel | 1 | Satisfied |
| PERM-07 | Namespace defaults via $wgFilePermNamespaceDefaults | 1 | Satisfied |
| PERM-08 | Invalid/missing treated as default | 1 | Satisfied |
| ENFC-01 | getUserPermissionsErrors hook denies File: page access | 2 | Satisfied |
| ENFC-02 | ImgAuthBeforeStream hook denies raw file downloads | 2 | Satisfied |
| ENFC-03 | Thumbnail access denied to unauthorized users | 2 | Satisfied |
| ENFC-04 | Embedded images fail to render for unauthorized users | 2 | Satisfied |
| ENFC-05 | Permission check fetches level from PageProps with default fallback | 2 | Satisfied |
| UPLD-01 | Permission dropdown on Special:Upload form | 3 | Satisfied |
| UPLD-02 | Dropdown options from $wgFilePermLevels | 3 | Satisfied |
| UPLD-03 | Default selection based on namespace/global default | 3 | Satisfied |
| UPLD-04 | UploadComplete stores selected level in PageProps | 3 | Satisfied |
| MSUP-01 | JS bridge loads when MsUpload is present | 5 | Satisfied |
| MSUP-02 | Permission dropdown in MsUpload toolbar | 5 | Satisfied |
| MSUP-03 | Dropdown defaults based on current namespace | 5 | Satisfied |
| MSUP-04 | Permission level appended to upload FormData | 5 | Satisfied |
| MSUP-05 | Server-side captures fileperm_level from request | 5 | Satisfied |
| FPUI-01 | Permission level displayed on File: pages | 4 | Satisfied |
| FPUI-02 | Sysop edit interface on File: pages | 4 | Satisfied |
| FPUI-03 | Permission edit accessible via dropdown + save | 4 | Satisfied |
| CONF-01 | Static Config class with typed access | 1 | Satisfied |
| CONF-02 | Configuration validation with fail-closed | 1 | Satisfied |

**Score: 27/27 requirements satisfied**

## Phase Verification Status

| Phase | Name | Verification | Status |
|-------|------|--------------|--------|
| 1 | Foundation & Infrastructure | 01-VERIFICATION.md | PASSED (5/5 truths) |
| 2 | Core Enforcement | 02-VERIFICATION.md | PASSED (5/5 truths) |
| 3 | Upload Integration | SUMMARY.md (no formal VERIFICATION.md) | PASSED (7/7 human checks) |
| 4 | Display & Management | SUMMARY.md (no formal VERIFICATION.md) | PASSED (9/9 human checks) |
| 5 | MsUpload Integration | 05-VERIFICATION.md | PASSED (5/5 truths) |
| 6 | VisualEditor Upload | 06-VERIFICATION.md | PASSED (5/5 truths) |

**Score: 6/6 phases passed**

Note: Phases 3 and 4 lack formal VERIFICATION.md files but have documented human verification results in their SUMMARY.md files showing all checks passed.

## Cross-Phase Integration

Integration checker verified 14 wiring points across all 6 phases.

| Integration Point | From | To | Status |
|-------------------|------|----|--------|
| PermissionService DI via ServiceWiring | Phase 1 | Phases 2,3,4 | CONNECTED |
| Config static access | Phase 1 | Phases 3,4,5,6 | CONNECTED |
| canUserAccessFile() enforcement | Phase 1 | Phase 2 (3 callers) | CONNECTED |
| setLevel() storage | Phase 1 | Phases 3,4 (2 callers) | CONNECTED |
| getLevel() reads | Phase 1 | Phases 2,4 (5 callers) | CONNECTED |
| resolveDefaultLevel() fallback | Phase 1 | Phases 2,3,5,6 (5 callers) | CONNECTED |
| wpFilePermLevel POST param | Phases 3,5,6 | Phase 3 handler (unified) | CONNECTED |
| fileperm-set-level API | Phase 4 JS | Phase 4 API module | CONNECTED |
| page_props storage key | Phase 1 | All phases (single constant) | CONNECTED |
| JS config vars PHP->JS | Phases 4,5,6 | JS modules (5 vars matched) | CONNECTED |
| i18n message keys | All phases | i18n/en.json (23 keys defined) | CONNECTED |
| extension.json hook registration | All phases | PHP handlers (10 hooks, 5 handlers) | CONNECTED |
| XHR interception coexistence | Phase 5 | Phase 6 (chaining + guards) | SAFE |
| edit-fileperm right + fileperm log type | Phase 4 | extension.json | CONNECTED |

**Score: 14/14 integration points connected**

## E2E Flow Verification

| # | Flow | Status |
|---|------|--------|
| 1 | Upload via Special:Upload -> select level -> stored -> enforced | COMPLETE |
| 2 | Upload via MsUpload -> select level -> stored -> enforced | COMPLETE |
| 3 | Upload via VisualEditor -> select level -> stored -> enforced | COMPLETE |
| 4 | Admin edits permission on File page -> new level enforced -> audit logged | COMPLETE |
| 5 | Upload without explicit level -> default applied -> enforcement works | COMPLETE |

**Score: 5/5 flows complete**

## Tech Debt

### By Phase

**Phase 1: Foundation & Infrastructure**
- Orphaned method: `PermissionService::removeLevel()` defined but no consumer in current codebase (valid API surface for future use)

**Phase 3: Upload Integration**
- Missing formal VERIFICATION.md file (verified via SUMMARY.md human verification results — all 7 checks passed)

**Phase 4: Display & Management**
- Missing formal VERIFICATION.md file (verified via SUMMARY.md human verification results — 9/9 checks passed)
- Steps 9-11 of verification plan deferred: non-sysop view behavior, file-without-level display

**Phase 6: VisualEditor Upload Integration**
- Orphaned i18n message: `filepermissions-ve-error-nolevels` defined in en.json and declared in extension.json messages array, but VE bridge JS silently returns instead of displaying the error (unlike MsUpload bridge which shows the error)

### Summary

**Total: 5 items across 4 phases**

All items are non-blocking:
- 2 orphaned code items (unused method, unused i18n key) — dead code, not integration failures
- 2 missing verification files — phases were verified via summaries with passing human test results
- 1 deferred verification scope — non-critical edge cases

## Bugs Found and Fixed During Development

Across all phases, 14 bugs were discovered during human verification and fixed in-place:

**Phase 2 (5 bugs):** Missing MessagesDirs, img_auth.php deployment requirement, direct /images/ bypass, parser cache staleness, SVG data URI escaping
**Phase 3 (4 bugs):** UploadCompleteHook signature mismatch, duplicate levels in dropdown, validation not blocking empty selection, PageProps storage failing (articleID=0)
**Phase 4 (5 bugs):** Non-existent ImagePageAfterImageLinksHook interface, JS executing before DOM ready, OOUI widgets not interactive without infusion, non-existent mediawiki.notify RL module, OOUI widgets missing infusion data

All bugs were found, fixed, and verified during their respective phase executions.

---
*Audited: 2026-01-29*
*Method: Phase verification aggregation + gsd-integration-checker cross-phase wiring analysis*
