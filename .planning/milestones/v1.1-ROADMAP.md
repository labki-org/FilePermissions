# Milestone v1.1: Testing & CI

**Status:** SHIPPED 2026-01-30
**Phases:** 7-10
**Total Plans:** 7

## Overview

Prove that the permission enforcement actually works -- from unit-level logic through HTTP-level leak checks -- and run it automatically on every PR.

## Phases

### Phase 7: Test Infrastructure & Unit Tests

**Goal**: Test discovery works and pure permission logic is verified without database or services
**Depends on**: v1.0 codebase (shipped)
**Plans**: 2 plans

Plans:
- [x] 07-01: Test infrastructure (TestAutoloadNamespaces, directory structure) + Config unit tests (43 scenarios)
- [x] 07-02: PermissionService unit tests with mocked dependencies (53 scenarios)

**Details:**
- TestAutoloadNamespaces configured in extension.json for MW test discovery
- tests/phpunit/unit/ and tests/phpunit/integration/ directory structure
- ConfigTest: 43 test scenarios covering all 7 Config public methods with fail-closed behavior
- PermissionServiceTest: 53 test scenarios covering all 6 public methods with mocked DB/UserGroupManager
- Patterns established: global save/restore with __UNSET__ sentinel, static data providers, fail-closed naming convention

**Requirements:** INFRA-01, INFRA-02, UNIT-01, UNIT-02, UNIT-03, UNIT-04, UNIT-05, UNIT-06
**Completed:** 2026-01-29

---

### Phase 8: Integration Tests

**Goal**: Enforcement hooks, API modules, and database operations are verified within the MediaWiki runtime
**Depends on**: Phase 7 (test infrastructure must exist for MW to discover integration tests)
**Plans**: 2 plans

Plans:
- [x] 08-01: PermissionService DB round-trip tests + EnforcementHooks integration tests (26 tests)
- [x] 08-02: UploadHooks integration tests + API module integration tests (22 tests)

**Details:**
- PermissionServiceDbTest: 12 tests for DB round-trip (INTG-09) and cache behavior (INTG-10)
- EnforcementHooksTest: 14 tests for getUserPermissionsErrors (INTG-01), ImgAuthBeforeStream (INTG-02), ImageBeforeProduceHTML (INTG-03)
- UploadHooksTest: 10 tests for upload verification rejection/acceptance (INTG-04) and level storage (INTG-05)
- ApiFilePermTest: 12 tests for set-level authorization (INTG-06, INTG-07) and query (INTG-08)
- Patterns established: overrideConfigValue, insertPage for file pages, FauxRequest injection, ApiUsageException assertion

**Requirements:** INTG-01, INTG-02, INTG-03, INTG-04, INTG-05, INTG-06, INTG-07, INTG-08, INTG-09, INTG-10
**Completed:** 2026-01-30

---

### Phase 9: E2E HTTP Leak Checks

**Goal**: Live HTTP requests prove unauthorized users cannot download protected file bytes through any access vector
**Depends on**: Phase 7 (E2E phpunit.xml and bootstrap), Phase 8 (integration tests prove DB operations work)
**Plans**: 2 plans

Plans:
- [x] 09-01: E2E test infrastructure (base class, MW API auth, file seeding, HTTP helpers) + Apache direct-path denial tests (6 tests)
- [x] 09-02: img_auth.php leak checks (8 tests) + full permission matrix (18 scenarios)

**Details:**
- E2ETestBase: Abstract base with cookie-based MW API clientlogin, PHP curl HTTP client, 3-level file seeding, bootstrap skip pattern
- DirectPathAccessTest: 6 tests proving Apache blocks /images/ and /images/thumb/ for all users (LEAK-03, LEAK-04)
- ImgAuthLeakTest: 8 tests proving img_auth.php denies unauthorized access and allows authorized downloads (LEAK-01, LEAK-02, LEAK-05, LEAK-06)
- PermissionMatrixTest: 18 parameterized cases covering 3 levels x 3 users x 2 vectors (LEAK-07)
- MW API cookie-based authentication for test users (LEAK-08)

**Requirements:** INFRA-03, INFRA-04, LEAK-01, LEAK-02, LEAK-03, LEAK-04, LEAK-05, LEAK-06, LEAK-07, LEAK-08
**Completed:** 2026-01-30

---

### Phase 10: CI Pipeline

**Goal**: All test tiers run automatically on every PR and push, and both jobs must pass for mergeability
**Depends on**: Phase 7, Phase 8, Phase 9 (all test suites must exist to run in CI)
**Plans**: 1 plan

Plans:
- [x] 10-01: GitHub Actions CI workflow (Docker health checks, unit/integration + E2E test jobs, merge gate)

**Details:**
- GitHub Actions workflow triggers on PRs to main and pushes to main (CI-01)
- Docker Compose starts with API-based health check polling, 120s timeout, 5s intervals (CI-02)
- Unit + integration tests run inside Docker container using MW's PHPUnit runner (CI-03)
- E2E HTTP leak checks run from runner against localhost:8888 (CI-04)
- Merge gate requires manual GitHub branch protection configuration (CI-05)
- Concurrency groups cancel stale runs on same PR

**Requirements:** CI-01, CI-02, CI-03, CI-04, CI-05
**Completed:** 2026-01-30

---

## Milestone Summary

**Key Decisions:**
- setUp/tearDown global save/restore with __UNSET__ sentinel for unit test isolation
- Static data providers for PHPUnit 10 forward compatibility
- overrideConfigValue instead of global save/restore for integration tests
- FauxRequest + RequestContext::setRequest() for upload hook parameter simulation
- PHP curl over Guzzle for E2E HTTP client (zero dependency)
- Cookie-based clientlogin over bot passwords (matches real user sessions)
- Single job with sequential steps for CI (avoids spinning up Docker twice)
- E2E tests run from runner via PHPUnit phar (E2ETestBase hardcodes localhost:8888)

**Issues Resolved:**
- All 7 critical pitfalls from research resolved during implementation
- PermissionService cache poisoning prevented via createService() helper and resetServiceForTesting
- File upload in integration tests resolved via insertPage for File: pages

**Issues Deferred:**
- CI-05 merge gate requires manual GitHub repo configuration (branch protection rules)
- Two human verification items pending: GitHub Actions trigger test and merge gate configuration

**Technical Debt Incurred:**
None. All phases executed cleanly with no deferred items, TODOs, stubs, or placeholders.

---

_For current project status, see .planning/MILESTONES.md_
