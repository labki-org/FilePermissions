# FilePermissions CI Pipeline
#
# Runs all test tiers on PRs to main and pushes to main:
#   CI-01: Triggers on pull_request and push to main
#   CI-02: Docker health check polling (not fixed sleep)
#   CI-03: Unit + Integration tests (inside Docker container via MW PHPUnit)
#   CI-04: E2E HTTP leak checks (against live wiki from runner)
#
# MERGE GATE (CI-05): Configure "test" as a required status check
# in GitHub repo Settings > Branches > Branch protection rules > main

name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Unit, Integration & E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Docker environment
        run: docker compose up -d

      # CI-02: Health check polling (not fixed sleep) confirms wiki readiness
      - name: Wait for wiki readiness
        run: |
          echo "Polling MediaWiki API for readiness (timeout: 120s)..."
          timeout 120 bash -c '
            until curl -sf "http://localhost:8888/api.php?action=query&meta=siteinfo&format=json" > /dev/null 2>&1; do
              echo "Waiting for wiki..."
              sleep 5
            done
          '
          echo "Wiki is ready."

      - name: Create test user
        run: |
          docker compose exec -T wiki php maintenance/run.php createAndPromote TestUser testpass123 || true

      - name: Run database update
        run: |
          docker compose exec -T wiki php maintenance/run.php update --quick

      # Install PHPUnit and MW test framework (dev dependencies)
      - name: Install Composer dev dependencies
        run: |
          docker compose exec -T -w /var/www/html wiki composer install

      # CI-03: Unit + integration tests run inside Docker container via MW test runner
      # Uses tests/phpunit/phpunit.php which bootstraps MediaWiki for
      # MediaWikiUnitTestCase and MediaWikiIntegrationTestCase base classes
      - name: Run unit and integration tests
        id: unit-integration
        run: |
          docker compose exec -T -w /var/www/html wiki php tests/phpunit/phpunit.php \
            --testdox \
            /mw-user-extensions/FilePermissions/tests/phpunit/unit/ \
            /mw-user-extensions/FilePermissions/tests/phpunit/integration/

      # CI-04: E2E leak checks run from the runner against live wiki
      - name: Install PHPUnit on runner
        run: |
          curl -L -o phpunit.phar https://phar.phpunit.de/phpunit-10.phar
          chmod +x phpunit.phar
          php phpunit.phar --version

      - name: Run E2E HTTP leak checks
        id: e2e
        run: |
          php phpunit.phar --testdox tests/phpunit/e2e/

      - name: Write test summary
        if: always()
        env:
          UNIT_RESULT: ${{ steps.unit-integration.outcome }}
          E2E_RESULT: ${{ steps.e2e.outcome }}
        run: |
          echo "## CI Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tier | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          if [ "$UNIT_RESULT" = "success" ]; then
            echo "| Unit + Integration | PASS |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| Unit + Integration | FAIL |" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "$E2E_RESULT" = "success" ]; then
            echo "| E2E HTTP Leak Checks | PASS |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| E2E HTTP Leak Checks | FAIL |" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Print Docker logs on failure
        if: failure()
        run: docker compose logs wiki
