# FilePermissions CI Pipeline
#
# Runs all test tiers on PRs to main and pushes to main:
#   CI-01: Triggers on pull_request and push to main
#   CI-02: Docker health check polling (not fixed sleep)
#   CI-03: Unit + Integration tests (inside Docker container via MW PHPUnit)
#   CI-04: E2E HTTP leak checks (against live wiki from runner)
#   CI-05: Playwright browser E2E tests (against live wiki from runner)
#
# MERGE GATE (CI-06): Configure "test" and "browser-tests" as required
# status checks in GitHub repo Settings > Branches > Branch protection rules > main

name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run phpcs
        run: composer phpcs

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install npm dependencies
        run: npm ci

      - name: Run eslint
        run: npm run lint

  test:
    name: Unit, Integration & E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      LABKI_PLATFORM_TAG: latest-dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Docker environment
        run: docker compose up -d

      # CI-02: Health check polling (not fixed sleep) confirms wiki readiness
      - name: Wait for wiki readiness
        run: |
          echo "Polling MediaWiki API for readiness (timeout: 120s)..."
          timeout 120 bash -c '
            until curl -sf "http://localhost:8888/api.php?action=query&meta=siteinfo&format=json" > /dev/null 2>&1; do
              echo "Waiting for wiki..."
              sleep 5
            done
          '
          echo "Wiki is ready."

      - name: Create test user
        run: |
          docker compose exec -T wiki php maintenance/run.php createAndPromote TestUser testpass123 || true

      - name: Run database update
        run: |
          docker compose exec -T wiki php maintenance/run.php update --quick

      # CI-03: Unit + integration tests via MW's test runner.
      # latest-dev image includes PHPUnit and dev autoloading, so
      # tests/phpunit/phpunit.php bootstraps MediaWiki and runs PHPUnit
      # with full support for MediaWikiUnitTestCase and
      # MediaWikiIntegrationTestCase base classes.
      - name: Run unit and integration tests
        id: unit-integration
        run: |
          docker compose exec -T -w /var/www/html wiki php tests/phpunit/phpunit.php \
            --testdox \
            /mw-user-extensions/FilePermissions/tests/phpunit/unit/ \
            /mw-user-extensions/FilePermissions/tests/phpunit/integration/

      # CI-04: E2E leak checks run from the runner against live wiki
      - name: Install PHPUnit on runner
        run: |
          curl -L -o phpunit.phar https://phar.phpunit.de/phpunit-10.phar
          chmod +x phpunit.phar
          php phpunit.phar --version

      - name: Run E2E HTTP leak checks
        id: e2e
        run: |
          php phpunit.phar \
            --bootstrap tests/phpunit/e2e/E2ETestBase.php \
            --testdox \
            tests/phpunit/e2e/

      - name: Write test summary
        if: always()
        env:
          UNIT_RESULT: ${{ steps.unit-integration.outcome }}
          E2E_RESULT: ${{ steps.e2e.outcome }}
        run: |
          echo "## CI Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tier | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          if [ "$UNIT_RESULT" = "success" ]; then
            echo "| Unit + Integration | PASS |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| Unit + Integration | FAIL |" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "$E2E_RESULT" = "success" ]; then
            echo "| E2E HTTP Leak Checks | PASS |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| E2E HTTP Leak Checks | FAIL |" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Print Docker logs on failure
        if: failure()
        run: docker compose logs wiki

  browser-tests:
    name: Playwright Browser Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      LABKI_PLATFORM_TAG: latest-dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start Docker environment
        run: docker compose up -d

      - name: Wait for wiki readiness
        run: |
          echo "Polling MediaWiki API for readiness (timeout: 120s)..."
          timeout 120 bash -c '
            until curl -sf "http://localhost:8888/api.php?action=query&meta=siteinfo&format=json" > /dev/null 2>&1; do
              echo "Waiting for wiki..."
              sleep 5
            done
          '
          echo "Wiki is ready."

      - name: Create test user
        run: |
          docker compose exec -T wiki php maintenance/run.php createAndPromote TestUser testpass123 || true

      - name: Run database update
        run: |
          docker compose exec -T wiki php maintenance/run.php update --quick

      - name: Run Playwright tests
        id: playwright
        run: npx playwright test

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload test traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 7

      - name: Print Docker logs on failure
        if: failure()
        run: docker compose logs wiki
